define(["jquery","commonUtils","jquery.lazyLoad"],function(s,a){var e=a,t={},i="",n="",o="",l=s("#headerTitle"),r=s(document),c=s("#ticketList"),p=s("#point"),d=s("#paySuccessInfo"),u=s("#singleTicketAdded"),h=s("#serviceCall"),v=s("#paySuccessInfo,#successTips"),f=s("#payOvertimeInfo,#overtimeTips"),m=function(){t=e.checkLogin(),t&&(i=t.userId),a.addMenu(),b(),I(),history.pushState(null,"","../salon/salonList.html");var s=!0;window.onpopstate=function(a){s||(location="../salon/salonList.html"),s=!1}},b=(function(){var s=d.parent().offset().top;r.on("scroll",function(){r.scrollTop()>=s?d.css({position:"fixed",top:"0px"}):d.css({position:"relative"})})}(),function(){var s=e.getQueryString("state"),a=e.getQueryString("msg");return 1==s?void e.alert(a,function(){window.history.go(-3)}):(n=e.getQueryString("shopcartsn"),o=e.getQueryString("orderSn"),n||o?void g():void e.alert("订单编号出错，请返回重新选择！"))}),g=function(){var a={};n?a={to:"requestTicket",type:"Shopcart",body:{userId:i,shopcartsn:n}}:o&&(a={to:"getTicket",type:"Order",body:{userId:i,orderSn:o}}),e.ajaxRequest({data:a,successCallback:function(a){if(a.result)w(a.data);else{if(o){l.text("支付成功"),s("#payOvertimeInfo,#overtimeTips").show();var t=[];t.push('<div class="clear" style="height: 15px;"></div>'),t.push('<div class="oib-list">'),t.push('<div class="oib-area"><span class="oib-label">订&nbsp;&nbsp;单&nbsp;&nbsp;号：</span><span class="order-no">'+o+"</span></div>"),t.push('<div class="oib-area"><span class="oib-label">商品名称：</span><span style="width: 75%;" class="text-overflow"></span>'),t.push(' <div class="oip-rule"><span class="oipr-text"></span></div></div>'),t.push('<div class="oib-area"><span class="oib-label">店铺名称：</span><span style="width: 75%;" class="text-overflow"></span></div>'),t.push("</div>"),c.html(t.join(""))}e.alert(a.msg),console.log("获取付款成功信息失败！"+a.msg)}},url:apiConfig.orderApi})},w=function(s){var a=s.main,e=[],t={},i=[],l=[];if(n){var r=s.other.haveTicket;1==r?S():k()}a.ticketInfo?(a.ticketInfo.addedService=a.addedService,e.push(a.ticketInfo)):e=a;for(var d=0,v=e.length;v>d;d++){t=e[d],i=e[d].addedService;var f=t.ticketNo;o&&(""!=f?S():k()),l.push('<div class="clear" style="height: 15px;"></div>'),l.push('<div class="oib-list">'),""!=f&&l.push('<div class="oib-area"><span class="oib-label">臭&nbsp;&nbsp;美&nbsp;&nbsp;券：</span><span class="order-no">'+f.substr(0,4)+"&nbsp;&nbsp;"+f.substr(4,8)+"</span></div>"),l.push('<div class="oib-area"><span class="oib-label">商品名称：</span><span style="width: 75%;" class="text-overflow">'+t.itemName+"</span>"),l.push(' <div class="oip-rule"><span class="oipr-text">'+(t.normsStr||"无规格")+"</span></div></div>"),l.push('<div class="oib-area" style="border-bottom:none"><span class="oib-label">店铺名称：</span><span style="width: 75%;" class="text-overflow">'+t.salonName+"</span></div>"),t.useLimit&&l.push('<div class="cart-item-area"><p class="cart-item-tips">消费限制：<span class="oib-label">'+t.useLimit+"</span></p></div>"),v>1?i&&i.length>0&&(l.push('<div class="oib-area addedServiceTip"><div class="title item-icon-right"><span class="oib-label">增值服务：</span><span style="width: 75%;" class="text-overflow">到店可享免费增值服务 '+i.length+'项</span><i class="icon icon-arrow-down animate"></i></div>'),l.push(x(i)),l.push("</div>")):i&&i.length>0&&u.show().append(x(i)),l.push("</div>")}c.html(l.join("")),v>1&&(y(),h.removeClass("stand-bg")),C(),s.other.growth?p.text(s.other.growth):p.text(e[0].growth)},y=function(){s(".addedServiceTip").on("click",function(){var a=s(this),e=a.find(".icon"),t=a.children(".addedService");t.hasClass("slideDownIn")?t.addClass("slideDownOut").removeClass("slideDownIn"):t.removeClass("slideDownOut").addClass("slideDownIn"),e.hasClass("animate-rotate-180")?e.addClass("animate-rotate-0").removeClass("animate-rotate-180"):e.addClass("animate-rotate-180").removeClass("animate-rotate-0")})},S=function(){l.text("购买成功"),v.show()},k=function(){l.text("支付成功"),f.show()},x=function(s){var a=[];a.push('<ul class="addedService">');for(var e=s.length,t=0;e>t;t++){var i=s[t];a.push('<li class="item-avatar">'),a.push('<img class="avatar sl-img lazy" src="../../images/default_salon.png" data-original="'+i.sLogo+'" alt="臭美增值服务" />'),a.push("<h2>"+i.sName+"</h2>"),a.push("<p>"+i.sDetail+"</p>"),a.push("</li>")}return a.push("</ul>"),a.join("")},C=function(){var a=s("img.lazy");a.length&&a.removeClass("lazy").lazyload({effect:"fadeIn"})},I=function(){s("#getAllTicketBtn").on("click",function(){window.location="../user/myTicket.html"}),s("#refreshBtn").on("click",function(){}),s("#continueShopBtn").on("click",function(){window.location="../salon/salonList.html"})};return{init:m}});