define(["jquery","commonUtils","libs/plugins/iscroll-min"],function(t,e,i){var s,a={},n="",l=[],o=[],r="",u="",d="",c="",m=1,p="",f="",g="";$writeEvaluateContent=t("#writeEvaluateContent"),$releaseEvaluateBtn=t("#releaseEvaluateBtn"),$wordCount=t("#wordCount"),$verySatistied=t("#verySatistied"),$hasSatistied=t("#hasSatistied"),$notSatistied=t("#notSatistied"),$notSatisfiedStatusBox=t("#notSatisfiedStatusBox"),$consumeTextarea=t("#consumeTextarea"),$uploadBtn=t("#uploadBtn"),$stylistListBox=t("#stylistListBox"),$selectStylist=t("#selectStylist"),$coverBg=t("#coverBg"),$scroller=t("#scroller");var h=!1,v=!1,S=function(){a=e.checkLogin(),a&&(n=a.userId),e.addBack(),r=e.getQueryString("evaluateItemName"),u=e.getQueryString("salonId"),d=e.getQueryString("itemId"),c=e.getQueryString("orderTicketId"),t("#edbItemName").text(r),y.getEvaluateInitData(),y.addEvaluateClickListener(),$consumeTextarea.on("input",function(){var e=t(this).val(),i=e.length;$wordCount.text(140-i).removeClass("main-color"),i>=135&&140>i?$wordCount.addClass("main-color"):i>=140&&($wordCount.text(0),$consumeTextarea.val(e.substring(0,140)))}),b.init(),y.getStylistListData(),y.selectStylist()},y={addEvaluateClickListener:function(){t("#verySatistied,#hasSatistied,#notSatistied").on("click",function(){m=t(this).attr("satisfyType"),$consumeTextarea.val(""),t(".ecbrl-status").siblings(".satisty-num").show(),t(this).addClass("ecbrl-on").attr("data-status","on").parent("li").siblings().find(".ecbrl-status").removeClass("ecbrl-on"),s.length<=0&&$selectStylist.hide()}),t("#verySatistied,#hasSatistied").on("click",function(){$releaseEvaluateBtn.addClass("main-color"),$writeEvaluateContent.show(),$notSatisfiedStatusBox.hide(),$consumeTextarea.val("").attr("placeholder","非常好的服务，剪发棒棒哒，下次还再来!")}),$notSatistied.on("click",function(){$writeEvaluateContent.hide(),$notSatisfiedStatusBox.show(),$releaseEvaluateBtn.removeClass("main-color")}),$releaseEvaluateBtn.on("click",function(){if(!v){p=$consumeTextarea.val(),$selectStylist.attr("hairStylistId")&&(g=$selectStylist.attr("hairStylistId"));var i=t(".ecb-result-list li").find(".ecbrl-on").length,s=$notSatisfiedStatusBox.find(".not-satistied-current").length;if(1==m)m="VERY_SATISFIED";else if(2==m)m="SATISFIED";else if(3==m){switch($notSatisfiedStatusBox.find("li").each(function(e,i){var s=t(i).attr("data-status");"current"==s&&(f=e+1,console.log(f))}),f){case 1:f="UNSATISFIED_SERVICE";break;case 2:f="UNSATISFIED_HAIRSTYLE";break;case 3:f="UNSATISFIED_CHARGE"}m="UNSATISFIED"}"VERY_SATISFIED"==m||"SATISFIED"==m?i>0?(e.showLoading(),v=!0,l.length>0?b.upload(function(){y.getEvaluateConsumeData.call(y)}):y.getEvaluateConsumeData()):e.alert("请选择一个评价满意度！"):i>0&&s>0?(e.showLoading(),v=!0,l.length>0?b.upload(function(){y.getEvaluateConsumeData.call(y)}):y.getEvaluateConsumeData()):e.alert("请选择一个评价满意度！")}})},getEvaluateInitData:function(){var t={to:"commentInit",type:"Order",body:{userId:n,salonId:u,itemId:d}};e.ajaxRequest({data:t,successCallback:this.getEvaluateInitCallback,url:apiConfig.orderApi})},getEvaluateInitCallback:function(e){if(e.result){var i=e.data.main,s=i.remark,a=[];$verySatistied.siblings(".satisty-num").text(i.satisfyOne),$hasSatistied.siblings(".satisty-num").text(i.satisfyTwo),$notSatistied.siblings(".satisty-num").text(i.satisfyThree),$notSatisfiedStatusBox.html("");for(var n=0;n<s.length;n++)a.push("<li>"+s[n]+"</li>");t(a.join("")).appendTo($notSatisfiedStatusBox)}t("#notSatisfiedStatusBox li").on("click",function(){$releaseEvaluateBtn.addClass("main-color"),$writeEvaluateContent.show(),$notSatisfiedStatusBox.hide(),t(this).addClass("not-satistied-current").attr("data-status","current")})},getEvaluateConsumeData:function(){""==o&&(h=!1);var t={userId:n,orderTicketId:c,itemId:d,salonId:u,hairStylistId:g,satisfyType:m,content:p,images:JSON.stringify(o),satisfyRemark:f,saveToAlbum:h};e.request({data:t,successCallback:this.getEvaluateConsumeCallBack,url:apiConfig.newApi+"comment/post-item.html"})},getEvaluateConsumeCallBack:function(t){if(0==t.code){var i=t.response,s=i.commentId;window.location="evaluateDetail.html?orderTicketId="+c+"&commentId="+s+"&salonId="+u+"&itemId="+d}else e.alert(t.message.replace("用户","亲，您"))},selectStylist:function(){$selectStylist.on("click",function(){$coverBg.show().removeClass("opacity-hide").addClass("opacity-show"),$stylistListBox.show().addClass("pull-left").removeClass("pull-right"),$stylistListBox.on("webkitAnimationEnd animationend",function(){new IScroll("#stylistListBox",{scrollbars:"",click:!0})})}),y.addStylistListListener(),$coverBg.on("click",function(){$coverBg.hide().addClass("opacity-hide").removeClass("opacity-show"),$stylistListBox.removeClass("pull-left").addClass("pull-right")})},getStylistListData:function(){var i={to:"index",type:"Stylist",body:{userId:n,salonId:u}};e.ajaxRequest({data:i,successCallback:function(i){if(i.result){s=i.data.main,stylistListDataLen=s.length,stylistListArr=[];for(var a=0;a<stylistListDataLen;a++)stylistListArr.push("<li hairStylistId="+s[a].stylistId+'><img onerror="this.src=../../images/user/gerenziliao_touxiang@2x.png" src='+s[a].stylistImg+">"),stylistListArr.push('<div class="slb-right"><p class="slbr-name">'+s[a].stylistName+"</p>"),stylistListArr.push('<p class="slbr-job"><span>'+s[a].job+"</span><span></span>"),stylistListArr.push("</p></div></li>");t(stylistListArr.join("")).appendTo($scroller),y.addStylistListListener()}else e.showTip("网络异常，请稍后再试！")},url:apiConfig.shopApi})},addStylistListListener:function(){$scroller.find("li").on("click",function(){g=t(this).attr("hairStylistId"),t(this).find("img").addClass("stylist-on").end().siblings().find("img").removeClass("stylist-on");var e=t(this).find(".slbr-name").text(),i=t(this).find(".slbr-job").find("span").eq(0).text(),s=t(this).find(".slbr-job").find("span").eq(1).text(),a=e+i+s;a='<span class="wecss-text01">选择设计师：'+e+'</span><span class="wecss-text02">'+i+'</span><span class="wecss-text03">'+s+"</span>",$selectStylist.html(a).attr("hairStylistId",g),$stylistListBox.removeClass("pull-left").addClass("pull-right"),$coverBg.hide().addClass("opacity-hide").removeClass("opacity-show"),setTimeout(function(){$stylistListBox.hide(),$coverBg.hide()},300)})},renderUploadDiv:function(){for(var e=l.length,i="",s=0;e>s&&5>s;s++){var a=t("#uploadImgDiv > div").eq(s);i='<div class="img" style="background-image:url('+l[s].thumbimg+')" bigImgSrc="'+l[s].img+'"</div>',a.html(i)}e>=5&&$uploadBtn.hide()}},b={uploaderObj:null,tokenArr:[],fileNum:5,finishCallback:null,init:function(){var i=t("#uploadBtn");i.on("click",function(){i.next().find("input[type=file]:eq(0)").click()}),e.require({fileList:["../../libs/plugins/qiniu/plupload.full.min.js","../../libs/plugins/qiniu/qiniu.min.js"],onFinish:function(){b.getToken(function(t){b.initUploader()})}})},getToken:function(t){e.request({data:{userId:a.userId,type:"2",num:"5"},url:apiConfig.newApi+"/file/qiniu/get-token.html",async:!0,successCallback:function(e){b.tokenArr=e.response.data,t&&t()}})},initUploader:function(){var i;return b.tokenArr.length>0?(i=b.tokenArr.shift(),void(this.uploaderObj=Qiniu.uploader({runtimes:"html5",browse_button:"uploadBtn",domain:apiConfig.qiniuServerApi,max_file_size:i.maxFileSize+"mb",filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}]},uptoken:i.uptoken,auto_start:!1,init:{FilesAdded:function(i,s){t.each(s,function(t,e){b.fileNum--<=0&&l.shift();var i=webkitURL.createObjectURL(e.getNative())||URL.createObjectURL(e.getNative());l.push({img:i,thumbimg:i})}),s.length>5&&e.showTip("最多只能上传5张照片！"),y.renderUploadDiv(),b.uploaderObj.refresh()},BeforeUpload:function(t,e){t.setOption({multipart:!0,multipart_params:{token:i.uptoken}}),i=b.tokenArr.shift()},UploadProgress:function(t,e){},FileUploaded:function(t,e,i){if("string"==typeof i&&(i=JSON.parse(i)),i.response){var s={img:i.response.img,thumbimg:i.response.thumbimg};o=o.concat(s)}l.shift(),0==l.length&&(b.uploaderObj.stop(),b.finishCallback())},Error:function(t,s,a){"File size error."==s.message?e.alert("文件大小不能超过"+i.maxFileSize+"mb"):e.alert(a)},UploadComplete:function(){},Key:function(t,e){}}}))):void b.getToken(b.initUploader)},upload:function(t){b.finishCallback=t,b.uploaderObj.start()}};return{init:S}});