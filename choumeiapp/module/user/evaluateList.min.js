define(["jquery","commonUtils"],function(e,t){var a={},i="",s=1,n=20,l="",o="",c="",r=0,u=0,p=0,d=function(){a=t.checkLogin(),a&&(i=a.userId),h.getEvaluateListData(),t.goTop();var s=t.getQueryString("activityTime");s&&(e("#ertTimes").html(s),e("#evaluate-redpacket-tips").show()),f()},h={getEvaluateListData:function(){var e={userId:i,page:s,pageSize:n};t.request({data:e,successCallback:this.getEvaluateListCallback,url:apiConfig.newApi+"order/history.html"})},getEvaluateListCallback:function(a){if(t.hideLoading(),0==a.code){var i=a.response,l=i.length,o=[];0==l&&1==s&&e("#noEvaluateTips").show();for(var c=0;l>c;c++){var r="",u=i[c].isCommented,p=i[c].satisfyType,d=i[c].itemFormat;o.push('<div class="seb-list" orderTicketId='+i[c].orderTicketId+">"),o.push('<h2 class="sebl-title salon-title" salonId='+i[c].salonId+">"+i[c].salonName+"</h2>"),o.push('<div class="sebl-title item-title"  itemId='+i[c].itemId+"><h2>"+i[c].itemName+"</h2>"),""!=d?o.push("<p>"+d+"</p>"):o.push("<p>无规格</p>"),o.push("</div>"),o.push('<div class="sebl-info clearfix">'),o.push('<p>臭美券密码：<span id="seblTicketNo">'+i[c].ticketNO.substring(0,4)+" "+i[c].ticketNO.substring(4,8)+"</span></p>"),o.push('<p class="clearfix"><span class="sebl-usetime">消费时间：<em id="seblUseTime">'+i[c].useTime+"</em></span>"),o.push('<span class="sebl-pay-amount">消费金额：<em id="seblPayAmount" class="main-color">￥'+i[c].amount+"</em></span></p></div>"),o.push('<p class="sebl-status clearfix">'),u?(o.push('<em  id="seblStatus">'+p+"</em>"),o.push('<a href="javascript:void(0)"  class="evaluate-btn view-evaluate">查看评价</a>'),"Y"==i[c].canLaisee&&("Y"==i[c].isValidLaisee?o.push('<a href="javascript:void(0)" class="evaluate-btn send-redpacket">查看红包</a>'):o.push('<a href="javascript:void(0)" class="evaluate-btn send-redpacket">分享</a>'))):(r="待点评",o.push('<em class="main-color" id="seblStatus">'+r+"</em>"),o.push('<a href="javascript:void(0)" class="evaluate-btn unvaluate">评价</a>')),o.push("</p></div>")}e("#evaluateListBox").append(e(o.join(""))),h.addEvaluateListener(),l>n&&1==s&&e(document).bind("scroll",h.addPageScrollListener),s++}else t.showTip(a.message)},addEvaluateListener:function(){e(".salon-title").off("click").on("click",function(){var t=e(this).attr("salonId");window.location="../salon/salonIndex.html?salonId="+t}),e(".item-title").off("click").on("click",function(){var t=e(this).siblings(".sebl-info").find("#seblTicketNo").text().replace(/[ ]/g,"");window.location="ticketDetail.html?ticketNo="+t}),e(".unvaluate").off("click").on("click",function(){l=e(this).parent(".sebl-status").siblings(".sebl-title").eq(0).attr("salonId"),o=e(this).parent(".sebl-status").siblings(".sebl-title").eq(1).attr("itemId"),c=e(this).parents(".seb-list").attr("orderTicketId");var t=e(this).parent(".sebl-status").siblings(".sebl-title").eq(0).text();window.location="evaluateConsume.html?orderTicketId="+c+"&salonId="+l+"&itemId="+o+"&evaluateItemName="+encodeURI(t)}),e(".view-evaluate").off("click").on("click",function(){l=e(this).parent(".sebl-status").siblings(".sebl-title").eq(0).attr("salonId"),o=e(this).parent(".sebl-status").siblings(".sebl-title").eq(1).attr("itemId"),c=e(this).parents(".seb-list").attr("orderTicketId"),window.location="evaluateDetail.html?orderTicketId="+c+"&salonId="+l+"&itemId="+o}),e(".send-redpacket").off("click").on("click",function(){c=e(this).parents(".seb-list").attr("orderTicketId");var a={orderTicketId:c};t.request({data:a,successCallback:function(a){0==a.code?(m.initData(a.response),e("#coverShare").show().off("click").on("click",function(){e(this).hide()})):t.showTip(a.message)},url:apiConfig.newApi+"laisee/creat-laisee.html"})})},addPageScrollListener:function(){r=e(document).height(),u=e(document).scrollTop(),p=e(window).height(),u+p>=r&&h.getEvaluateListData()}},m={shareTimelineData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}},shareAppMessageData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",desc:"良辰最喜欢对那些跟我关系好的人出手了，拯救你们的发型，就用臭美App！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",type:"link",dataUrl:"",trigger:function(e){},success:function(){},cancel:function(){},fail:function(){}},initData:function(e){m.shareAppMessageData.title=m.shareTimelineData.title=e.wechatTitle,m.shareAppMessageData.link=m.shareTimelineData.link=e.h5URL,m.shareAppMessageData.imgUrl=m.shareTimelineData.imgUrl=e.imgURL,m.shareTimelineData.desc=e.wechatContent},wxCallback:function(a){wx&&(wx.config({debug:!1,appId:a.appId,timestamp:a.timestamp,nonceStr:a.nonceStr,signature:a.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){wx.checkJsApi({jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],success:function(a){var i;"string"==typeof a?i=e.parseJSON(a):"object"==typeof a&&(i=a),i.checkResult.onMenuShareTimeline?wx.onMenuShareTimeline(m.shareTimelineData):t.alert("分享到朋友圈功能不可用！"),i.checkResult.onMenuShareAppMessage?wx.onMenuShareAppMessage(m.shareAppMessageData):t.alert("分享给朋友功能不可用！")},fail:function(){}})}),wx.error(function(e){}))}},f=function(){var e={to:"signPackage",type:"Wechat",body:{url:window.location.href.split("#")[0]}};t.ajaxRequest({data:e,successCallback:function(e){if(1!=e.result)t.alert(e.msg);else{var a=e.data.main;m.wxCallback(a)}},url:apiConfig.userApi})};return{init:d}});