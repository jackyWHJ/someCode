define(["jquery","commonUtils","libs/plugins/swiper/swiper.min"],function(e,t,i){var a={},n=[],s=[],l="",o="",r=2,u="",c="",d="",m="",p=e("#modifyReputationBtn"),g=e("#verySatistied"),f=e("#hasSatistied"),h=e("#wordCount"),b=(e("#userImgUrl"),""),v=e("#replyContent"),k=e("#consumeTextarea"),y=e("#releaseEvaluateBtn"),w=e("#uploadBtn"),x=e("#edbRedpacketBtn"),I=function(){a=t.checkLogin(),a&&(o=a.userId),t.addBack(),b=t.getQueryString("orderTicketId"),u=t.getQueryString("satisfyRemark"),c=t.getQueryString("salonId"),d=t.getQueryString("itemId"),S.getEvaluateDetailData(),S.addModifySatisfyListener(),S.getModifySatisfyReleaseData(),k.on("input",function(){var t=e(this).val(),i=t.length;h.text(140-i).removeClass("main-color"),i>=135&&140>i?h.addClass("main-color"):i>=140&&(h.text(0),k.val(t.substring(0,140)))}),T.init(),A()},S={getEvaluateDetailData:function(){var e={userId:o,orderTicketId:b};t.request({data:e,successCallback:this.getEvaluateDetailCallback,url:apiConfig.newApi+"user/comment.html"})},getEvaluateDetailCallback:function(i){if(0==i.code){var a=i.response,n=a.satisfyType;"不满意"==n&&(n="不满意",e("#edbtEvaluateResult").removeClass("edbt-has-satisfied").addClass("edbt-not-satisfied")),e("#edbtItemName").text(a.itemName),e("#edbtSalonName").text(a.salonName),e("#edbtEvaluateTime").text(a.addTime),e("#edbtEvaluateResult").text(n),"Y"==a.canLaisee&&("Y"!=a.isValidLaisee&&x.text("分享"),x.show().off("click").on("click",function(){var i={orderTicketId:b};t.request({data:i,successCallback:function(i){0==i.code?(C.initData(i.response),e("#coverShare").show().off("click").on("click",function(){e(this).hide()})):t.showTip(i.message)},url:apiConfig.newApi+"laisee/creat-laisee.html"})})),m=a.content,""!=m?e("#edbText").text(m):e("#edbText").hide(),-1!=n.indexOf("不满意")&&p.show();var s=a.images||[];if(l=s,s.length>0){for(var o="",r=e("#edbImgBox"),u=0,c=s.length;c>u;u++)5>u&&(o+='<div><img class="evaluate-img" src="'+s[u].thumb.url+'" bigImgSrc="'+s[u].image.url+'" picIndex="'+u+'"></div>'),r.html(o);e(".evaluate-img").on("click",function(){var i=e(this).attr("picIndex");t.showSwipeBox(s,{initialSlide:i})})}else e("#edbNoImgTips").show();v.text(a.reply),""==v.text()&&v.hide()}},addModifySatisfyListener:function(){e("#verySatistied,#hasSatistied").on("click",function(){e(this).addClass("ecbrl-on").attr("data-status","on").parent("li").siblings().find(".ecbrl-status").removeClass("ecbrl-on"),r=e(this).attr("satisfyType")}),p.on("click",function(){e("#edbWrap,#edbtEvaluateResult").hide(),e(this).hide(),e(".ecbrl-status").siblings(".satisty-num").show(),e("#modifyReputationWrap").show(),y.show();for(var i=l.length,a="",n=0;i>n&&(l[n]={img:l[n].image.url,thumbimg:l[n].thumb.url},5>n);n++){var s=e("#uploadImgDiv > div").eq(n);a='<div class="img" style="background-image:url('+l[n].thumbimg+')" bigImgSrc="'+l[n].img+'"</div>',s.html(a)}i>=5&&w.hide();var r={to:"commentInit",type:"Order",body:{userId:o,salonId:c,itemId:d}};t.ajaxRequest({data:r,successCallback:function(e){if(e.result){var t=e.data.main;t.remark;g.siblings(".satisty-num").text(t.satisfyOne),f.siblings(".satisty-num").text(t.satisfyTwo)}},url:apiConfig.orderApi})})},getModifySatisfyReleaseData:function(){y.on("click",function(){var i=e(".mrw-result-list li").find(".ecbrl-on").length;i>0?(t.showLoading(),T.upload(function(){n=l.concat(n),m=e("#consumeTextarea").val();var i={to:"doComment",type:"Order",body:{userId:o,orderTicketId:b,salonId:c,itemId:d,satisfyType:r,content:m,imgSrc:JSON.stringify(n),satisfyRemark:"",type:2}};t.ajaxRequest({data:i,successCallback:function(e){if(e.result){var i=e.data.main;d=i.itemId,c=i.salonId,window.location="evaluateDetail.html?orderTicketId="+b+"&itemId="+d+"&salonId="+c}else t.alert(e.msg.replace("用户","亲，您"))},url:apiConfig.orderApi})})):t.alert("请选择一个评价满意度！")})},renderUploadDiv:function(){for(var t=[].concat(l,s),i=t.length,a="",n=0;i>n&&5>n;n++){var o=e("#uploadImgDiv > div").eq(n);a='<div class="img" style="background-image:url('+t[n].thumbimg+')" bigImgSrc="'+t[n].img+'"</div>',o.html(a)}i>=5&&w.hide()}},T={uploaderObj:null,tokenArr:[],fileNum:5,finishCallback:null,init:function(){var i=e("#uploadBtn");i.on("click",function(){i.next().find("input[type=file]:eq(0)").click()}),t.require({fileList:["../../libs/plugins/qiniu/plupload.full.min.js","../../libs/plugins/qiniu/qiniu.min.js"],onFinish:function(){T.getToken(function(){T.initUploader()})}})},getToken:function(e){t.request({data:{userId:a.userId,type:"2",num:"5"},url:apiConfig.newApi+"/file/qiniu/get-token.html",async:!0,successCallback:function(t){T.tokenArr=t.response.data,e&&e()}})},initUploader:function(){var i;return T.tokenArr.length>0?(i=T.tokenArr.shift(),void(this.uploaderObj=Qiniu.uploader({runtimes:"html5",browse_button:"uploadBtn",domain:apiConfig.qiniuServerApi,max_file_size:i.maxFileSize+"mb",filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}]},uptoken:i.uptoken,auto_start:!1,init:{FilesAdded:function(i,a){e.each(a,function(e,t){0!=l.length&&s.length+l.length>=5?l.shift():s.length+l.length>=5&&s.shift();var i=webkitURL.createObjectURL(t.getNative())||URL.createObjectURL(t.getNative());s.push({img:i,thumbimg:i})}),a.length>5&&t.showTip("最多只能上传5张照片！"),S.renderUploadDiv(),T.uploaderObj.refresh()},BeforeUpload:function(e,t){e.setOption({multipart:!0,multipart_params:{token:i.uptoken}}),i=T.tokenArr.shift()},UploadProgress:function(e,t){},FileUploaded:function(e,t,i){if("string"==typeof i&&(i=JSON.parse(i)),i.response){var a={img:i.response.img,thumbimg:i.response.thumbimg};n=n.concat(a)}s.shift(),0==s.length&&(T.uploaderObj.stop(),T.finishCallback())},Error:function(e,a,n){"File size error."==a.message?t.alert("文件大小不能超过"+i.maxFileSize+"mb"):t.alert(n)},UploadComplete:function(){},Key:function(e,t){}}}))):void T.getToken(T.initUploader)},upload:function(e){return 0==s.length&&e?void e():(T.finishCallback=e,void T.uploaderObj.start())}},C={shareTimelineData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}},shareAppMessageData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",desc:"良辰最喜欢对那些跟我关系好的人出手了，拯救你们的发型，就用臭美App！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",type:"link",dataUrl:"",trigger:function(e){},success:function(){},cancel:function(){},fail:function(){}},initData:function(e){C.shareAppMessageData.title=C.shareTimelineData.title=e.wechatTitle,C.shareAppMessageData.link=C.shareTimelineData.link=e.h5URL,C.shareAppMessageData.imgUrl=C.shareTimelineData.imgUrl=e.imgURL,C.shareTimelineData.desc=e.wechatContent},wxCallback:function(i){wx&&(wx.config({debug:!1,appId:i.appId,timestamp:i.timestamp,nonceStr:i.nonceStr,signature:i.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){wx.checkJsApi({jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],success:function(i){var a;"string"==typeof i?a=e.parseJSON(i):"object"==typeof i&&(a=i),a.checkResult.onMenuShareTimeline?wx.onMenuShareTimeline(C.shareTimelineData):t.alert("分享到朋友圈功能不可用！"),a.checkResult.onMenuShareAppMessage?wx.onMenuShareAppMessage(C.shareAppMessageData):t.alert("分享给朋友功能不可用！")},fail:function(){}})}),wx.error(function(e){}))}},A=function(){var e={to:"signPackage",type:"Wechat",body:{url:window.location.href.split("#")[0]}};t.ajaxRequest({data:e,successCallback:function(e){if(1==e.result){var i=e.data.main;C.wxCallback(i)}else t.alert(e.msg)},url:apiConfig.userApi})};return{init:I}});