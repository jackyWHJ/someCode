define(["jquery","commonUtils","jquery.lazyLoad"],function(i,a){var t={addr:{addrLati:window.localStorage.getItem("addrLati")||geoLoc.addrLati,addrLong:window.localStorage.getItem("addrLong")||geoLoc.addrLong},addrCom:null,init:function(){t.setPosition()},setPosition:function(){window.navigator.geolocation?(a.showLoading(),window.navigator.geolocation.getCurrentPosition(function(i){addrLong=i.coords.longitude,addrLati=i.coords.latitude;var e=new BMap.Point(addrLong,addrLati);BMap.Convertor.translate(e,0,function(i){window.localStorage.setItem("addrLong",i.lng),window.localStorage.setItem("addrLati",i.lat),t.addr.addrLong=i.lng,t.addr.addrLati=i.lat;var e=new BMap.Geocoder;e.getLocation(i,function(i){t.addrCom=i.addressComponents,o.init()}),a.hideLoading()})},function(i){a.alert("我们为您准备了更好的推荐服务，请允许微信访问地理位置信息\n您可以在“设置”中允许微信访问位置信息。"),o.init(),a.hideLoading()},{enableHighAccuracy:!0,timeout:5e3})):a.alert("浏览器不支持html5来获取地理位置信息")}},e=i("#circle"),s=i("#district"),n=i("#zone"),o={init:function(){o.data.requestData.type=a.getQueryString("itemType")||"",this.view.init(),this.action.init()},loadTag:{end:!1,firstTime:!0},itemTypeMap:{type_1:{name:"洗剪吹",img:"../../images/home/xianmuliebiao_xijiaochui_icon@2x.png"},type_2:{name:"烫发",img:"../../images/home/xianmuliebiao_tangfa_icon@2x.png"},type_3:{name:"染发",img:"../../images/home/xianmuliebiao_ranfa_icon@2x.png"},type_4:{name:"护发",img:"../../images/home/xianmuliebiao_hufa_icon@2x.png"},type_5:{name:"套餐",img:"../../images/home/xianmuliebiao_taocan_icon@2x.png"},type_7:{name:"洗吹",img:"../../images/home/xianmuliebiao_xichui_icon@2x.png"},type_8:{name:"15分钟快剪",img:"../../images/home/xiangmu_shijian@2x.png"}},data:{districtList:null,priceList:null,requestData:{pageNum:1,pageSize:10,district:0,zone:0,lati:t.addr.addrLati,"long":t.addr.addrLong,priceTag:0,itemType:1,type:1},listData:{}},view:{init:function(){this.initItemType(),this.initDistrictList(),this.initPosNav()},initPosNav:function(){i("#sl-h-pos").on("click",function(){var a=i(this);a.toggleClass("active"),e.toggle()})},initItemType:function(){var a=o.itemTypeMap["type_"+o.data.requestData.type];a&&(i("#h-itemImg").attr("src",a.img),i("#h-itemName").html(a.name),i("#header").show()),8==o.data.requestData.type?(i("#priceList,#ilAddress,#header").remove(),i("body").addClass("quickcutListPage"),this.initQuickCutBanner()):i("#il-banner").remove()},initDistrictList:function(){a.request({url:apiConfig.newApi+"location/allArea.html",data:{type:0},successCallback:function(i){0==i.code?(o.data.districtList=i.response,o.view.initPriceList(),o.view.setDistrict()):a.showTip(i.message)}})},initPriceList:function(){var t=i("#priceList"),e=[];a.ajaxRequest({url:apiConfig.shopApi,data:{type:"Item",to:"priceRange",body:{type:o.data.requestData.type}},successCallback:function(a){var s=o.data.priceList=a.data.main;i.each(s.priceRange,function(i,a){e.push('<li rangeId = "'+a.rangeId+'">'+a.rangeTitle+"</li>")}),t.html(e.join("")),i("#priceList").on("click","li",function(){o.data.requestData.priceTag=i(this).attr("rangeId"),i(this).addClass("active").siblings().removeClass("active"),o.action.loadList(!0)}),o.action.loadList(!0)}})},setDistrict:function(){var a=[],e=null;if(t.addrCom&&(e=t.addrCom.district),i.each(o.data.districtList,function(i,t){a.push('<li district="'+t.tId+'">'+t.tName+"</li>"),e&&e==t.tName&&(o.data.requestData.district=t.tId)}),s.html(a.join("")),!e){var n=s.find("li:first");n.addClass("active"),o.data.requestData.district=n.attr("district")}o.view.setZoom(),s.on("click","li",function(){o.data.requestData.district=i(this).attr("district"),o.view.setZoom()})},setZoom:function(){s.find("li[district="+o.data.requestData.district+"]").addClass("active").siblings().removeClass("active");var a=[],t=[];i.each(o.data.districtList,function(i,a){o.data.requestData.district==a.tId&&(t=a.areaInfo)}),i.each(t,function(i,t){a.push('<li zone="'+t.areaId+'">'+t.areaName+"</li>")}),o.data.requestData.zone=n.html(a.join("")).find("li:first").addClass("active").attr("zone"),n.off("click").on("click","li",function(){var a=i(this);a.addClass("active").siblings().removeClass("active"),o.data.requestData.zone=a.attr("zone"),i("#sl-h-posText").text(s.find("li[district="+o.data.requestData.district+"]").text()),i("#sl-h-pos").click(),o.action.loadList(!0)})},updateItemList:function(a){var t=o.data.listData,e=i("#noItemList"),s=i("#itemList");if(a?(o.loadTag.firstTime=!0,o.loadTag.end=!1,s.empty()):o.loadTag.firstTime=!1,0==t.length)return o.loadTag.end=!0,o.loadTag.firstTime&&(e.show(),s.hide()),-1;s.show(),e.hide();var n=[],d=i("#itemList");i.each(t,function(i,a){var t;t=8!=o.itemType?"<li itemId="+a.itemId+'><img src="../../images/default_img.png" data-original='+a.itemLogo.thumb+' alt="臭美项目" class="il-img lazy" /><div class="il-info"><h1 class="il-name">'+a.itemName+'</h1><div class="il-price"><span class="il-pCM text-overflow">臭美价：<span class="red-color">￥'+a.price+"</span></span>"+(2==o.type?"":'<span class="il-pOri">原价：￥'+a.priceOri+"</span>")+'</div><div class="il-shop"><span class="il-shopName">'+a.salonName+'</span><span class="il-shopPos"><span class="il-spName">'+a.area+'</span><span class="il-spDis">'+a.dist+"</span></span></div></div></li>":"<li itemId="+a.itemId+'><img src="../../images/default_img.png" data-original='+a.itemLogo.thumb+' alt="臭美项目" class="il-img lazy" /><div class="il-info"><h1 class="il-name">'+a.itemName+'</h1><div class="il-shop"><span class="il-shopName">'+a.salonName+'</span></div><div class="bottomCon"><span class="il-shopPos"><span class="il-spName">'+a.area+'</span><span class="il-spDis">'+a.dist+'</span></span></div><div class="il-price"><span class="il-pCM">臭美价<span class="unit">￥</span><span class="price">'+a.price+'</span></span><br><span class="il-pOri">原价<span class="price">'+a.priceOri+"</span></span></div></li>",n.push(t)}),d.append(n.join("")),o.data.requestData.pageNum++,d.off("click").on("click","li",function(){location="../home/itemDetail.html?itemId="+i(this).attr("itemId")}),i("img.lazy").removeClass("lazy").lazyload({effect:"fadeIn"})},initQuickCutBanner:function(){var a=i("#il-banner"),t="../../images/home/kuaijian_banner_bg@2x.png";a.append('<img src="../../images/home/kuaijian_banner_bg@2x.png" alt="banner" data-original='+t+" />"),a.show(),a.find("img").lazyload({effect:"fadeIn"})}},action:{init:function(){function a(){if(!o.loadTag.end){if(1==i("#itemList:hidden").length)return;var a=i(document),t=i(window).height();a.scrollTop()+t>=a.height()&&o.action.loadList()}}i(document).on("scroll",a)},loadList:function(i){i&&(o.data.requestData.pageNum=1),a.request({url:apiConfig.newApi+"salon/item-list.html",data:o.data.requestData,successCallback:function(a){0==a.code&&(o.data.listData=a.response,o.view.updateItemList(i))}})}}};return{init:t.init}});