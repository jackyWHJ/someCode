define(["jquery","commonUtils"],function(e,t){function n(){var n=e("#userImg");t.require({fileList:["../../libs/plugins/qiniu/plupload.full.min.js","../../libs/plugins/qiniu/qiniu.min.js"],onFinish:function(){var e,o=function(){t.request({data:{userId:i.userId,type:"1",num:"1"},url:apiConfig.newApi+"/file/qiniu/get-token.html",async:!0,successCallback:function(t){e=t.response.data[0],a()}})},a=function(){var i=Qiniu.uploader({runtimes:"html5",browse_button:"userImg",domain:apiConfig.qiniuServerApi,max_file_size:e.maxFileSize+"mb",filters:{mime_types:[{title:"Image files",extensions:"jpg,gif,png,jpeg"}]},uptoken:e.uptoken,auto_start:!0,init:{FilesAdded:function(e,t){},BeforeUpload:function(e,t){},UploadProgress:function(e,t){},FileUploaded:function(e,t,a){"string"==typeof a&&(a=JSON.parse(a));var s=a.response.img;n.css("background-image","url("+s+")"),c=s,y(),i.destroy(),o()},Error:function(n,i,o){"File size error."==i.message?t.alert("文件大小不能超过"+e.maxFileSize+"mb"):t.alert(o)},UploadComplete:function(){},Key:function(t,n){return e.fileName}}})};o()}})}var i={},o="",a=[],s=[],r=[],c="",u=0,l=0,p=(e("#userImgUrl"),function(){return(i=JSON.parse(window.sessionStorage.getItem("user")||window.localStorage.getItem("user")))?(o=i.userId,i.accessToken||(t.alert("你的登录信息失效！请重新登录！"),window.sessionStorage.setItem("location",window.location),location="userLogin.html"),t.addBack(),t.addMenu(),d(),m(),h(),n(),e("#loginOutBtn").on("click",function(){t.confirm("确定退出当前账号吗？",function(e){if(e){window.sessionStorage.removeItem("user"),window.localStorage.removeItem("user"),window.sessionStorage.setItem("location",window.location);var t="userLogin.html";window.location=t}})}),void e("#nickNameBtn").on("click",function(){window.location="setName.html"})):void t.authorize()}),d=function(){var t='<option value="-1">不选</option>';a=areaObj.citylist;for(var n=0,i=a.length;i>n;n++)t+='<option value="'+n+'">'+a[n].p+"</option>";e("#provinceSelect").html(t),e("#provinceSelect").on("change",function(){u=e(this).val(),-1!=u&&(e("#province-span").text(a[u].p),e("#city-span").text(a[u].c[0].n),g(),window.sessionStorage.setItem("cityIndex",u),window.localStorage.setItem("cityIndex",u))}),JSON.parse(window.sessionStorage.getItem("cityIndex")||window.localStorage.getItem("cityIndex"))&&(u=JSON.parse(window.sessionStorage.getItem("cityIndex")||window.localStorage.getItem("cityIndex"))),g()},g=function(){var t='<option value="-1">不选</option>';s=a[u].c;for(var n=0,i=s.length;i>n;n++)t+='<option value="'+n+'">'+s[n].n+"</option>";e("#citySelect").html(t),e("#citySelect").on("change",function(){l=e(this).val(),-1!=l&&(e("#city-span").text(s[l].n),s[l].a?(e("#countrySelect").show(),e("#country-span").text(s[l].a[0].s),f()):(e("#country-span").text(""),e("#countrySelect").unbind("change"),e("#countrySelect").html('<option value=""></option>'),e("#countrySelect").hide(),w()),window.sessionStorage.setItem("countryIndex",l),window.localStorage.setItem("countryIndex",l))}),JSON.parse(window.sessionStorage.getItem("countryIndex")||window.localStorage.getItem("countryIndex"))&&(l=JSON.parse(window.sessionStorage.getItem("countryIndex")||window.localStorage.getItem("countryIndex"))),s[l].a&&f()},f=function(){var t='<option value="-1">不选</option>';r=a[u].c[l].a;for(var n=0,i=r.length;i>n;n++)t+='<option value="'+n+'">'+r[n].s+"</option>";e("#countrySelect").html(t),e("#countrySelect").unbind("change"),e("#countrySelect").bind("change",function(){var t=e(this).val();-1!=t&&(e("#country-span").text(r[t].s),w())})},m=function(){if(navigator.userAgent.indexOf("Android")>-1){var t=e("#dateInput");t.data("value",t.val());setInterval(function(){t.data("value")!=t.val()&&(e("#dateVal").text(t.val()),b())},1e3)}else e("#dateInput").on("change",function(){e("#dateVal").text(e(this).val()),b()})},y=function(){var e={to:"updateInfo",type:"User",body:{userId:o,img:c}};t.ajaxRequest({data:e,successCallback:function(e){e.result},url:apiConfig.userApi})},h=function(){var e={to:"info",type:"User",body:{userId:o}};t.ajaxRequest({data:e,successCallback:v,url:apiConfig.userApi})},v=function(n){if(n.result){var o=n.data.main.user;if(i=e.extend(!0,i,o),window.sessionStorage.setItem("user",JSON.stringify(i)),window.localStorage.setItem("user",JSON.stringify(i)),e("#imgForm").append("<input type='hidden' name='userId' value='1'><input type='hidden' name='type' value='1'>"),i.img&&e("#userImg").css("background-image","url("+i.img+")"),e("#nickName").text(i.nickname),i.sex&&(1==i.sex?e("#sex-span").text("女"):2==i.sex&&e("#sex-span").text("男"),e("#sexSelect").val(i.sex)),i.hairType&&(1==i.hairType?e("#hair-span").text("长发"):2==i.hairType?e("#hair-span").text("中发"):3==i.hairType&&e("#hair-span").text("短发"),e("#hairSelect").val(i.hairType)),i.area){var a=i.area.split(",");if(a.length>1){var s=a[0]||"",r=a[1]||"";e("#provinceSelect").val(s),e("#province-span").text(s),e("#citySelect").val(r),e("#city-span").text(r),e("#countrySelect").hide()}a.length>2&&(e("#countrySelect").show().val(a[2]),e("#country-span").text(a[2]))}i.birthday&&e("#dateVal").text(i.birthday),i.mobilephone&&e("#mabBindTel").text(i.mobilephone.substring(0,3)+"****"+i.mobilephone.substring(7,11))}else t.showTip(n.msg);x()},x=function(){e("#sexSelect").on("change",function(){e("#sex-span").html(e(this).find("option:selected").text()),I()}),e("#hairSelect").on("change",function(){e("#hair-span").html(e(this).find("option:selected").text()),S()}),e("#yearSelect").on("change",function(){e("#year-span").html(e(this).val())})},w=function(){var n=e("#province-span").text(),i=e("#city-span").text(),a=e("#country-span").text(),s="";s=a?n+","+i+","+a:n+","+i;var r={to:"updateInfo",type:"User",body:{userId:o,area:s}};t.ajaxRequest({data:r,successCallback:function(e){e.result||t.showTip(e.msg)},url:apiConfig.userApi})},I=function(){var n=e("#sexSelect").val(),i={to:"updateInfo",type:"User",body:{userId:o,sex:n}};t.ajaxRequest({data:i,successCallback:function(e){e.result||t.showTip(e.msg)},url:apiConfig.userApi})},S=function(){var n=e("#hairSelect").val(),i={to:"updateInfo",type:"User",body:{userId:o,hairtype:n}};t.ajaxRequest({data:i,successCallback:function(e){e.result||t.showTip(e.msg)},url:apiConfig.userApi})},b=function(){var n=e("#dateVal").text(),i={to:"updateInfo",type:"User",body:{userId:o,birthday:n}};t.ajaxRequest({data:i,successCallback:function(e){e.result||t.showTip(e.msg)},url:apiConfig.userApi})};return{init:p}});