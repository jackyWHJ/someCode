define(["jquery","commonUtils"],function(e,t){var i="",a={},n=1,s=20,o="",r={},l={},c=(e("#orderTitle"),function(){a=t.checkLogin(),a&&(i=a.userId),t.addBack(),t.addMenu(),o=t.getQueryString("orderType"),d.getOrderData(),u()}),d={getOrderData:function(){t.request({data:{userId:i,pageNum:n,pageSize:s},successCallback:d.getCallBack,url:apiConfig.newApi+"user/all-order-list.html"})},getCallBack:function(t){if(0==t.code){var i=t.response.items,a=i.length,o=[];0==a&&1==n&&e("#noContentTips").show(),e.each(i,function(e,t){var i=t.type,a=t.orderSn,n=t.itemId,s=t.salonId,l=t.orderTicketId,c=t.articleCodeId,d=t.ticketNo,p=t.canLaisee,u=t.isValidLaisee,h=t.status,m="",f=t.isGift,w=t.type,g="",k=Math.random(),b=k++;switch(h){case 1:m="未消费";break;case 2:m="未评价";break;case 3:m="已评价";break;case 4:m="已完成";break;case 5:m="退款中";break;case 6:m="已退款";break;case 7:m="已过期"}o.push('<div class="order-list">'),o.push('<p class="ol-header"><span class="text-overflow">'+t.salonName+"</span>"),"1"==h||"2"==h||"5"==h?o.push('<em class="main-color">'+m+"</em></p>"):o.push("<em>"+m+"</em></p>"),"MF"==w?o.push('<div class="ol-info" itemId='+n+">"):c?o.push('<div class="ol-info"  articleCodeId='+c+">"):o.push('<div class="ol-info"  orderSn='+a+">"),o.push('<img onerror="this.src=\'../../images/default_img.png\'" src="'+t.imgUrl+'" class="oli-img"/>'),o.push('<div class="oli-right"><p class="olir-text1 text-overflow">'+t.itemName),c&&"Y"==f&&o.push('<i class="gift-tips">赠送</i>');var g="MF"==w?"":"预约金";(w="MF")?g="臭美价":(g="预约金",c&&"Y"==f&&(g="会员疗程价")),o.push('</p><p class="olir-text2">'+g+'<span class="main-color">￥'+t.money+"</span></p>"),o.push('<p class="olir-text3">购买时间：'+t.payTime+"</p></div></div>"),o.push('<p class="ol-bottom">'),"MF"==i?("5"!=h&&"6"!=h&&o.push('<span class="olb-btn view-cmticket" ticketNo='+d+">查看臭美券</span>"),"2"==h?o.push('<span class="olb-btn evaluate-btn" itemId='+n+" salonId="+s+" orderTicketId="+l+">评价</span>"):"3"==h&&(o.push('<span class="olb-btn view-evalutate" itemId='+n+" salonId="+s+" orderTicketId="+l+">查看评价</span>"),"Y"==p&&("Y"==u?o.push('<span class="olb-btn view-redpacket" orderTicketId='+l+">查看红包</span>"):o.push('<span class="olb-btn view-redpacket" orderTicketId='+l+">分享</span>")))):("4"==h||"1"==h)&&(c?o.push('<span class="olb-btn view-booking-btn"  articleCodeId='+c+">查看预约单</span>"):o.push('<span class="olb-btn view-booking-btn" orderSn='+a+">查看预约单</span>")),"5"==h||"6"==h?(d?o.push('<span class="olb-btn view-refunds" ticketNo='+d+" dataKey="+b+">退款详情</span>"):o.push('<span class="olb-btn view-refunds" orderSn='+a+" dataKey="+b+">退款详情</span>"),r[b]=t):"8"==h&&o.push('<span class="olb-btn view-refunds" orderSn='+a+" dataKey="+b+" status="+h+">退款详情</span>"),c&&"Y"==f&&o.push('<span class="ol-valid">有效期 '+t.giftStartTime+"至 "+t.giftEndTime+"</span>"),o.push("</p></div></div>")}),e("#orderBox").append(e(o.join(""))),a>=s&&1==n&&e(document).bind("scroll",d.addPageScrollListener),n++,d.addOrderListener()}},addOrderListener:function(){e(".ol-info").off("click").on("click",function(){l=r[e(this).attr("dataKey")],window.sessionStorage.setItem("item",JSON.stringify(l)),window.localStorage.setItem("item",JSON.stringify(l));var t=e(this).attr("itemId"),i=e(this).attr("orderSn"),a=e(this).attr("articleCodeId");t?window.location="../home/itemDetail.html?itemId="+t:i&&(a?window.location="../appoint/appoint-detail.html?articleCodeId="+a:window.location="../appoint/appoint-detail.html?beautySn="+i)}),e(".view-cmticket").off("click").on("click",function(){var t=e(this).attr("ticketNo");window.location="ticketDetail.html?ticketNo="+t}),e(".view-booking-btn").off("click").on("click",function(){var t=e(this).attr("orderSn"),i=e(this).attr("articleCodeId");i?window.location="../appoint/appoint-detail.html?articleCodeId="+i:window.location="../appoint/appoint-detail.html?beautySn="+t}),e(".evaluate-btn").off("click").on("click",function(){var t=e(this).attr("salonId"),i=e(this).attr("itemId"),a=e(this).attr("orderTicketId"),n=e(this).parent().siblings(".ol-info").find(".olir-text1").text();window.location="evaluateConsume.html?salonId="+t+"&itemId="+i+"&orderTicketId="+a+"&itemName="+encodeURI(n)}),e(".view-evalutate").off("click").on("click",function(){var t=e(this).attr("salonId"),i=e(this).attr("itemId"),a=e(this).attr("orderTicketId");window.location="evaluateDetail.html?orderTicketId="+a+"&salonId="+t+"&itemId="+i}),e(".view-refunds").off("click").on("click",function(){l=r[e(this).attr("dataKey")],window.sessionStorage.setItem("item",JSON.stringify(l)),window.localStorage.setItem("item",JSON.stringify(l));var t=e(this).attr("ticketNo"),i=(e(this).attr("bookingSn"),e(this).attr("orderSn"));t?window.location="refundsDetail.html?ticketNo="+t:window.location="refundsDetail.html?orderSn="+i}),e(".view-redpacket").off("click").on("click",function(){var i=e(this).attr("orderTicketId");t.request({data:{orderTicketId:i},successCallback:function(i){0==i.code?(p.initData(i.response),e("#coverShare").show().off("click").on("click",function(){e(this).hide()})):t.showTip(i.message)},url:apiConfig.newApi+"laisee/creat-laisee.html"})})},addPageScrollListener:function(){var t=e(document).height(),i=e(document).scrollTop(),a=e(window).height();i+a>=t&&d.getOrderData()}},p={shareTimelineData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}},shareAppMessageData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",desc:"良辰最喜欢对那些跟我关系好的人出手了，拯救你们的发型，就用臭美App！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",type:"link",dataUrl:"",trigger:function(e){},success:function(){},cancel:function(){},fail:function(){}},initData:function(e){p.shareAppMessageData.title=p.shareTimelineData.title=e.wechatTitle,p.shareAppMessageData.link=p.shareTimelineData.link=e.h5URL,p.shareAppMessageData.imgUrl=p.shareTimelineData.imgUrl=e.imgURL,p.shareTimelineData.desc=e.wechatContent},wxCallback:function(i){wx&&(wx.config({debug:!1,appId:i.appId,timestamp:i.timestamp,nonceStr:i.nonceStr,signature:i.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){wx.checkJsApi({jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],success:function(i){var a;"string"==typeof i?a=e.parseJSON(i):"object"==typeof i&&(a=i),a.checkResult.onMenuShareTimeline?wx.onMenuShareTimeline(p.shareTimelineData):t.alert("分享到朋友圈功能不可用！"),a.checkResult.onMenuShareAppMessage?wx.onMenuShareAppMessage(p.shareAppMessageData):t.alert("分享给朋友功能不可用！")},fail:function(){}})}),wx.error(function(e){}))}},u=function(){var e={to:"signPackage",type:"Wechat",body:{url:window.location.href.split("#")[0]}};t.ajaxRequest({data:e,successCallback:function(e){if(1!=e.result)t.alert(e.msg);else{var i=e.data.main;p.wxCallback(i)}},url:apiConfig.userApi})};return{init:c}});