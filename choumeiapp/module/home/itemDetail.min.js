define(["jquery","commonUtils","utils/module/tongdun","swiper","jquery.lazyLoad"],function(t,e,i,s,a){var n={},o="",c="",r=0,l="",d="",p=1,m=0,u=0,h=0,v=t("#itemNum"),g=t("#joinCartElem"),f=[],w=[],b=[],I={},x=function(){return e.addBack(),e.addMenu(),n=JSON.parse(window.sessionStorage.getItem("user")||window.localStorage.getItem("user")),n&&(c=n.userId),o=e.getQueryString("itemId"),l=window.localStorage.getItem("addrLati")||geoLoc.addrLati,d=window.localStorage.getItem("addrLong")||geoLoc.addrLong,e.checkGeoLoc(),o?(y(),t("#buyBtn1,#buyBtn2").bind("click",function(){return c?b.indexOf("no")>=0?void e.alert("请先选择规格"):1==t(this).attr("showTip")&&1==t(this).attr("btnNo")?(N(),t("#addCartBtn2").hide(),t("#buyBtn2").addClass("id-big-btn").css("display","inline-block"),void t("#popPage").animate({top:0},500)):void q():(window.sessionStorage.setItem("location",window.location),void(window.location="../user/userLogin.html"))}),void t("#addCartBtn1,#addCartBtn2").bind("click",function(){return c?b.indexOf("no")>=0?void e.alert("请先选择规格"):1==t(this).attr("showTip")&&1==t(this).attr("btnNo")?(N(),t("#buyBtn2").hide(),t("#addCartBtn2").addClass("id-big-btn").css("display","inline-block"),void t("#popPage").animate({top:0},500)):void R():(window.sessionStorage.setItem("location",window.location),void(window.location="../user/userLogin.html"))})):void e.alert("项目编号出错，请返回重新选择！")},y=function(){var t={userId:c,itemId:o,addrLati:l,addrLong:d};e.request({data:t,successCallback:function(t){0==t.code?C(t.response):(e.showTip(t.message),console.log("获取商家信息失败！"+t.message))},url:apiConfig.newApi+"salon/item-detail.html"})},C=function(i){var s=i.item,a=i.salon,n=i.format,o={},l="",d="";if(n){l=i.format.formatTypes,d=i.format.norms;var p=999999,v=null;t.each(d,function(t,e){p>e.price&&(p=e.price,v=t)}),o={normsId:v,price:d[v].price,priceOri:d[v].priceOri}}if(2==s.itemType){t("#saleBtn").show(),t("#itemName").css("width","80%");var g=[];if(s.saleRule.length>0){var f=s.saleRule.length;g.push('<ul class="cart-item-condition clearfix">');for(var w=0;f>w;w++)g.push("<li>"+s.saleRule[w]+"</li>");g.push("</ul>"),t("#descType").append(t(g.join(""))).show(),t("#priceRule").addClass("pr-special")}var b=s.useLimit;""!=b&&t("#cartItemTips").text(b).show(),t("#priceP").hide()}s.logo&&t("#itemImg,#itemImg2").html('<img src="'+s.logo+'"/>'),t("#itemName").text(s.name),n?(s.price==s.maxPrice?t("#priceDis").text("￥"+s.price):t("#priceDis").text("￥"+s.price+"~"+s.maxPrice),s.priceOri==s.maxPriceOri?t("#price").text("￥"+s.priceOri):t("#price").text("￥"+s.priceOri+"~"+s.maxPriceOri),m=o.price,u=o.priceOri,t("#priceDis2").text("臭美价：￥"+m),t("#price2").text("原    价：￥"+u),d[o.normsId]&&d[o.normsId].normsId&&(h=d[o.normsId].normsId),t("#priceRule").show()):(t("#priceDis").text("￥"+s.price),t("#price").text("￥"+s.priceOri),m=s.price,u=s.priceOri),s.saleNum&&t("#itemMsg").text(s.saleNum+"人购买");var I=s.isDown;1==I&&(t("#buyBtn2,#buyBtn1").unbind("click").text("项目已下架").css("background-color","#cbcbcb"),t("#addCartBtn1,#addCartBtn2").unbind("click").css("background-color","#cbcbcb")),t("#serviceDesc").html(e.transferString(s.desc));var x=s.expTime;""!=x&&t("#serviceDesc").append('<div class="id-item-time">项目使用有效期至：'+s.expTime+"<span></span></div>"),r=a.salonId,t("#shopBtn").attr("salonId",a.salonId).on("click",function(){window.location="../salon/salonIndex.html?salonId="+r}),a.logo&&t("#shopImg").attr("src",a.logo),t("#shopName").text(a.name),t("#sl-stars").text(a.stars),a.commentNum&&t("#evaluateNum").text(a.commentNum);var y=i.item.commentNum;if(y&&t("#evaluateNum2").text(y),t("#satisfaction").text(a.satisfaction),t("#shopAddr p").text(a.addr),t("#shopDist").html(a.dist),t("#shopAddr").attr("addrLati",a.lati),t("#shopAddr").attr("addrLong",a.lng),1==s.collected?(t("#collectIcon").addClass("id-collected-btn"),t("#collectBtn").attr("type","1")):(t("#collectIcon").removeClass("id-collected-btn"),t("#collectBtn").attr("type","2")),t("#shopAddr").on("click",function(){var t=a.lati,e=a.lng;window.location="http://api.map.baidu.com/marker?location="+t+","+e+"&title="+a.name+"&content="+a.addr+"&output=html&src=臭美"}),D(),n&&(t("#buyBtn1").attr("showTip",1),t("#addCartBtn1").attr("showTip",1),k(l,o),O(d),t("#priceRule").show()),i.comment&&B(i.comment,s),c&&L(),e.imgError(),i.addedServices)var C=i.addedServices,T=C.length;if(T>0){for(var S=[],w=0;T>w;w++)S.push('<li><img class="avatar" src="'+C[w].logo+'">'),S.push('<div class="isb-text"><p>'+C[w].name+"</p>"),S.push('<p class="isbt-description">'+C[w].detail+"</p></div></li>");t("#incrementServiceList").append(t(S.join(""))),t("#incrementServiceBox").show(),e.imgError()}else t("#incrementServiceBox").hide()},k=function(e,i){for(var s=[],a=[],n=0,o=e.length;o>n;n++){a=[],s.push("<div><p>"+e[n].name+"</p>");for(var c=0,r=e[n].detail.length;r>c;c++)s.push('<div id="specItem'+e[n].detail[c].formatId+'" itemId="'+e[n].detail[c].formatId+'" able="1" select="0" rowId="'+n+'" class="spec-btn">'+e[n].detail[c].name+"</div>"),f.push(e[n].detail[c].formatId),a.push(e[n].detail[c].formatId);I[n]=a,s.push("</div>")}t("#specDiv").html(s.join("")),i.normsId&&(b=i.normsId.split(","));for(var l=[],d=0,p=b.length;p>d;d++){var m=t("#specItem"+b[d]);m.addClass("spec-slected-btn"),m.attr("selected",1),l.push(m.text())}t("#itemName2").text(l.join("、"))},B=function(i,s){var a=[];a.push('<div class="id-btn-div"><div class="id-evaluate-btn text-overflow" satisfyType="1">很满意('+s.verySatisfy+')</div><div class="id-evaluate-btn text-overflow" satisfyType="2">满意('+s.satisfy+')</div><div class="id-evaluate-btn text-overflow" satisfyType="3">不满意('+s.unsatisfy+")</div></div>");var n=[];if(i){if(a.push('<div class="vc-cl-content"><div class="vc-cl-head">'),""!=i.img?a.push('<img src="'+i.img+'" class="vc-cl-headImg">'):a.push('<img src="../../images/user/gerenziliao_touxiang@2x.png" class="vc-cl-headImg">'),a.push('<span class="csi">'+i.satisfy+'</span><span class="vc-cl-tel">'+i.phone+"</span></div>"),a.push('<div class="vc-cl-comment"><p class="vc-cl-commentDesc">'+i.content+"</p>"),a.push('<ul class="vc-cl-imgList">'),n=i.commentImg)var o=n.length;if(o>0)for(var c=0;o>c;c++)a.push('<li><img src="'+n[c].thumbimg+'" class="vc-cl-img"></li>');a.push('</ul></div><div id="swiper-containerWrap"></div>'),a.push('<p class="vc-cl-time">'+i.time.substr(0,10)+"</p>"),i.reply&&a.push('<p class="vc-cl-reply">'+i.reply+"</p>"),a.push("</div>")}t("#evaluateContent").append(a.join("")).show();var r,l=t("#swiper-containerWrap");l.hide(),t(".vc-cl-imgList").on("click","li",function(){r||(r=e.showSwipeBox(n,{pagination:"#swiper-containerWrap .swiper-pagination"})),r.slideTo(t(this).index(),0),l.show()}),t(".vc-cl-imgList li").each(function(){var e=t(this);e.height(e.width())}),P()},T=function(){var t={to:"collectItem",type:"User",body:{userId:c,itemId:o}};e.ajaxRequest({data:t,successCallback:S,url:apiConfig.userApi})},S=function(i){if(i.result){var s=i.data.main.isCollect;1==s?t("#collectIcon").removeClass("id-collected-btn").addClass("cancel-scale"):t("#collectIcon").removeClass("cancel-scale").addClass("do-scale id-collected-btn"),e.showTip(i.data.main.info)}else e.showTip(i.msg),console.log("收藏/取消收藏失败！"+i.msg)},L=function(){var i={userId:c};e.request({data:i,successCallback:function(i){if(0==i.code){var s=i.response.totalQuantity;s&&null!=s&&(s>99?t("#itemNum").text("99+"):t("#itemNum").text(s))}else e.showTip(i.message)},url:apiConfig.newApi+"cart/quantity.html"})},N=function(){var e=t(window).height();t("#popPage").css("top",e+"px").show();var i=t("#specDiv").height();i+162>e?t("#specContent").css("height",e-162+"px"):(t("#specContent").css("height",i+20+"px"),t("#specPage").css("top",e-162-i+"px"))},O=function(e){var i=[],s=[],a=[];for(var n in e)i.push(n);t(".spec-btn").on("click",function(){var n=t(this).attr("able");if(0!=n){var o=t(this).attr("rowId"),c=t(this).attr("itemId");1==t(this).attr("select")?(t(this).attr("select",0),b[o]="no"):(t(this).addClass("spec-slected-btn").attr("select",1),b[o]=c),w=[],a=i;for(var r=0,l=b.length;l>r;r++)if(0!=b[r]&&l-1>r){s=[];for(var d=0,v=a.length;v>d;d++)a[d].indexOf(b[r])>=0&&s.push(a[d]);if(s.length<I[r+1].length){for(var g=[],f=0,x=s.length;x>f;f++)g.push(s[f].split(",")[r+1]);for(var y=0,C=I[r+1].length;C>y;y++)g.indexOf(I[r+1][y])<0&&w.push(I[r+1][y]);break}a=s,s=[]}if(j(),e[b.join(",")]){m=e[b.join(",")].priceOri,u=e[b.join(",")].price;for(var k="",r=0,l=b.length;l>r;r++)k+=t("#specItem"+b[r]).text()+"，";t("#itemName2").text(k.substr(0,k.length-1)),t("#priceDis2").text("臭美价：￥"+u*p),t("#price2").text("原    价：￥"+m*p),h=e[b.join(",")].normsId}}})},j=function(){for(var e="",i=0,s=f.length;s>i;i++)e=t("#specItem"+f[i]),e.removeClass("spec-slected-btn").removeClass("spec-btn-enable").attr("able",1).attr("select",0);for(var i=0,s=b.length;s>i;i++)e=t("#specItem"+b[i]),e.addClass("spec-slected-btn").attr("select",1);for(var i=0,s=w.length;s>i;i++)e=t("#specItem"+w[i]),e.removeClass("spec-slected-btn").addClass("spec-btn-enable"),1==e.attr("select")&&(b[e.attr("rowId")]=0,e.attr("select",0)),e.attr("able",0)},D=function(){t("#priceRule").on("click",function(){N(),t("#buyBtn2,#addCartBtn2").removeClass("id-big-btn").css("display","inline-block"),t("#popPage").animate({top:0},500)}),t("#specCloseBtn").on("click",function(){A(),t("#buyBtn1").attr("showTip",0)}),t("#collectBtn").on("click",function(){return c?void T():(window.sessionStorage.setItem("location",window.location),void(window.location="../user/userLogin.html"))}),t("#evaTitle").on("click",function(){window.location="viewComment.html?itemId="+o+"&type=2&satisfyType=0"}),t("#moreShop").on("click",function(){window.location="../salon/branch.html?salonId="+encodeURI(r)+"&addrLati="+l+"&addrLong="+d}),t("#serviceSureBtn").on("click",function(){window.location="../activity/bet/bet.html"}),t("#cartBtn").on("click",function(){window.location="../cart/cart.html"})},P=function(){t(".id-evaluate-btn").on("click",function(){var e=t(this).attr("satisfyType");window.location="viewComment.html?itemId="+o+"&type=2&satisfyType="+e})},A=function(){t("#priceDis").text("￥"+u*p),t("#price").text("￥"+m*p),t("#popPage").animate({top:t(window).height()+"px"},500);for(var e="",i=0,s=b.length;s>i;i++)e+=t("#specItem"+b[i]).text()+"，";e=e.length>0?e.substr(0,e.length-1):"规格不限",t("#itemSelectLabel > span").text(e)},R=function(){var i={userId:c,itemId:o,normsId:h};e.request({data:i,successCallback:function(i){t("#popPage").animate({top:t(window).height()+"px"},300),0==i.code?(e.showTip("恭喜，已添加至购物车！"),E()):e.showTip(i.message)},url:apiConfig.newApi+"cart/add.html"})},q=function(){var t={userId:c,itemId:o,salonId:r,normsId:h};tongdun({url:"/order/instant/submit.html",data:{userId:c,itemId:o,salonId:r,salonNormsId:h}}),e.request({data:t,successCallback:function(t){0==t.code?(sessionStorage.setItem("bill-buynow",JSON.stringify(t.response)),window.location="../cart/cartOrder.html?orderSn="+t.response.orderSn):(e.alert(t.message),console.log("提交订单信息失败！"+t.message))},url:apiConfig.newApi+"order/place.html"})},E=function(){var e=v.text();e.indexOf("+")<0&&(e=Number(e)+1),e>=99?v.text("99+"):v.text(e),t("#joinCartElem").addClass("join-cart-run"),v.addClass("cart-tips-scale"),g.on("webkitAnimationEnd animationEnd",function(){g.removeClass("join-cart-run")}),v.on("webkitAnimationEnd animationEnd",function(){v.removeClass("cart-tips-scale")})};return{init:x}});