var scratch=function(){var t=$(window).height(),a=$(window).width(),i=$("#lock"),n=$("#scratchBox"),e=$("#scratchImg"),c=$("#getTicketProcess"),s=$("#coverBg"),o=$(".btn-share"),r=($("#scratchCanvas"),$("#winBox")),h=$("#loseBox"),g=$("#noChanceBox"),d=$("#btnGetTicket"),c=$("#getTicketProcess"),l=$("#gtpImg"),m=document.getElementById("scratchCanvas"),w="",v=function(){C(),p(),y(),u()},p=function(){var i=1.36*a;$(".scratch-box,.sb-bg").height(i);var n=.69*a,c=.4*n;e.css({width:n,height:c,bottom:.075*t}),l.height(.35*a),o.on("click",function(t){t.stopPropagation(),s.show(),$("#shareTips").show(),$(this).parent(".result-box").hide()}),s.on("click",function(){$(this).hide(),$(this).children().hide()}),window.localStorage.getItem("sessionRandom")&&(w=window.localStorage.getItem("sessionRandom"),1==w&&(s.show(),g.show(),s.unbind("click")))},u=function(){var t=!("onorientationchange"in window);t||(window.addEventListener("orientationchange",function(){0!=window.orientation?i.show():i.hide()},!1),0!=window.orientation&&i.show())},C=function(){commonUtils.loaderImg({data:["../../../images/activity/scratchCard/bg.jpg","../../../images/activity/scratchCard/scratch_wrap.png","../../../images/activity/scratchCard/scratch_mask.png","../../../images/activity/scratchCard/scratch_win.png","../../../images/activity/scratchCard/scratch_lose.png","../../../images/activity/scratchCard/result_win.png","../../../images/activity/scratchCard/result_lose.png","../../../images/activity/scratchCard/result_nochance.png","../../../images/activity/scratchCard/btn_get_ticket.png","../../../images/activity/scratchCard/btn_share1.png","../../../images/activity/scratchCard/btn_share2.png","../../../images/activity/scratchCard/btn_share3.png","../../../images/activity/scratchCard/btn_download.png","../../../images/activity/scratchCard/share_tips.png","../../../images/activity/scratchCard/process.png","../../../images/activity/scratchCard/process_img.jpg","../../../images/activity/scratchCard/share_img.png","../../../images/activity/scratchCard/phone_147x219.png"],onProgress:function(t){$("#loadingTips").text(parseInt(100*t)+"%")},onFinish:function(){setTimeout(function(){$("#loadingBox").hide(),$("#scratchCardBox").show()},500)}})},f=function(t,a){var i=m.getBoundingClientRect();return{x:t-i.left*(m.width/i.width),y:a-i.top*(m.height/i.height)}},y=function(){var t=m.getContext("2d");m.width=$("#scratchImg").width(),m.height=$("#scratchImg").height();var a=new Image;a.src="../../../images/activity/scratchCard/scratch_mask.png",a.onload=function(){t.drawImage(a,0,0,m.width,m.height),t.globalCompositeOperation="destination-out",randomVal=Math.floor(2*Math.random()),(""!=w&&0==w||1==w)&&(randomVal=1),m.addEventListener("touchmove",function(a){window.localStorage.setItem("sessionRandom",randomVal),0==randomVal?e.removeClass("simg-win").addClass("simg-lose"):e.removeClass("simg-lose").addClass("simg-win"),a.preventDefault();var i=f(a.targetTouches[0].clientX,a.targetTouches[0].clientY);t.beginPath(),t.fillStyle="#f00",t.arc(i.x,i.y,20,0,2*Math.PI),t.fill(),t.closePath()}),m.addEventListener("touchend",function(a){a.preventDefault();for(var i=0,n=t.getImageData(0,0,m.width,m.height),e=0;e<n.data.length;e++)0==n.data[e]&&i++;i>=.5*n.data.length&&(t.fillRect(0,0,m.width,m.height),_())})}},_=function(){s.show(),0==randomVal?h.show():(r.show(),d.on("click",function(){var a=$("#gtpContent").height()+l.height();console.log(a),t>a&&c.css({position:"absolute"}),n.hide(),c.show()}))};return{Init:v}}();scratch.Init();