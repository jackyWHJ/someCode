define(["jquery","commonUtils","jquery.lazyLoad"],function(e,i){return function(){function t(e){switch(e.laiseeStatus){case"1":a();break;case"2":s();break;case"3":o();break;case"4":l();break;case"5":r(e);break;case"0":r(e)}}function n(){e("#resultTip").css("visibility","hidden"),e("#useTicket,#inputPhoneOuterWrap,#noTicket,#noTicket-accountTip,#accountInfo,#help").hide(),e("#resultPage").show(),i.hideLoading()}function a(){n(),e("#end").show()}function s(){n(),e("#noTicket").show(),e("#noTicket-accountTip").show()}function o(){n(),"臭美"!=b.result.postNickname&&(e("logo").attr("src",b.result.postImg||"images/cmlogo.png"),e("#resultTip .getTicketTip").html('<span class="bigger">我是'+(b.result.postNickname||"臭美")+"</span><br />恭喜你抢到了我的现金券，下次美发试试臭美呗！")),e("#resultTip").css("visibility","visible"),e("#inputPhoneOuterWrap").show()}function l(){location="fail.html"}function r(i){n(),e("#resultTip").css("visibility","visible");var t=[];e("#accountInfo,#useTicket,#help").show(),"臭美"!=i.postNickname&&(e("logo").attr("src",i.postImg||"images/cmlogo.png"),e("#resultTip .getTicketTip").html('<span class="bigger">我是'+i.postNickname+"</span><br />恭喜你抢到了我的现金券，下次美发试试臭美呗！")),e.each(i.laiseeList,function(e,i){t.push('<div class="ticketWrap"><div class="ticket resultTicket "><span class="typeWrap"><span class="ticketType">现金券</span><br /><span class="itemType">'),t.push(i.type),t.push('</span></span><span class="price">'),t.push(i.value),t.push('<span class="unit">元</span></span>'),t.push('</div><img src="images/ticket.png" alt="券" class="ticketImg" /></div>')}),e("#ticketList").prepend(t.join("")),e("#ticket-phone").html(b.mobilephone)}function c(){i.request({data:{orderTicketId:m,mobilephone:mobilephone||k.mobilephone,imgURL:k.imgURL,nickName:k.nickName,openIdEncrypt:k.openIdEncrypt,h5_redirect_url:h+"/module/activity/hongbao/result.html?orderTicketId="+m},url:apiConfig.newApi+"laisee/get-laisee-by-mobilephone.html",successCallback:function(n){return 0!=n.code?void i.alert(n.message):(e("#inputPhoneOuterWrap").hide(),k.mobilephone=mobilephone,b.mobilephone=mobilephone,b.result=n.response,b.result.getResulted=!0,localStorage.setItem(d,JSON.stringify(b)),localStorage.setItem(f,JSON.stringify(k)),t(n.response),void p())}})}function p(){i.request({data:{orderTicketId:m},url:apiConfig.newApi+"laisee/get-laisee-list.html",successCallback:u})}function u(i){if(0==i.code){var t=[];e.each(i.response.laiseeList,function(e,i){t.push('<dd><img src="images/default_img.png" alt="用户头像" class="head lazy" data-original='+i.imgURL),t.push(' /><div class="info"><div class="con"><div class="name">'+i.nickName),t.push('</div><p class="msg">'+i.laiseeComment),t.push('</p><div class="time">'+i.getTime),t.push('</div></div><div class="price">'+i.value),t.push("元</div></div></dd>")}),e("#historyList dd").remove(),e("#historyList").append(t.join("")),e("img.lazy").removeClass("lazy").lazyload({effect:"fadeIn"})}}function g(){e("#changePhonePage").show(),e("#resultPage").hide(),e("#currentPhone").html(b.mobilephone)}var h=location.toString().substring(0,location.toString().indexOf("module/")),m=i.getQueryString("orderTicketId"),d="hongbao-result-"+m,f="hongbao-userInfo";i.getQueryString("noCache")&&(localStorage.removeItem(d),localStorage.removeItem(f));var b=JSON.parse(localStorage.getItem(d))||{mobilephone:null,getResulted:!1,orderTicketId:m,result:{laiseeList:null,laiseeStatus:null}},k=JSON.parse(localStorage.getItem(f))||{mobilephone:null,nickName:null,imgURL:null,openIdEncrypt:null},y={orderTicketId:m,mobilephone:i.getQueryString("mobilephone"),result:{laiseeStatus:i.getQueryString("laiseeStatus"),laiseeList:JSON.parse(i.getQueryString("laiseeList")),postNickname:i.getQueryString("postNickname"),postImg:i.getQueryString("postImg")}},S={mobilephone:i.getQueryString("mobilephone"),nickName:i.getQueryString("nickName"),imgURL:i.getQueryString("imgURL"),openIdEncrypt:i.getQueryString("openIdEncrypt")};if(null!==y.result.laiseeStatus&&(b.result.getResulted=!0,e.extend(!0,b,y),localStorage.setItem(d,JSON.stringify(b)),e.extend(!0,k,S),localStorage.setItem(f,JSON.stringify(S))),k.mobilephone!=b.mobilephone)k.mobilephone?mobilephone=k.mobilephone:mobilephone=b.mobilephone,c();else{if(!b.result.getResulted)return void(location=apiConfig.newApi+"laisee/get-laisee-by-wechat.html?request={'orderTicketId':'"+m+"','mobilephone':'"+k.mobilephone+"'}&h5_redirect_url="+h+"/module/activity/hongbao/result.html?orderTicketId="+m);t(b.result)}!function(){i.showLoading()}(),e("#getTicketBtn").on("click",function(){mobilephone=e("#input-phone").val(),/^1\d{10}$/.test(mobilephone)?(e("#ipnut-phoneWrap").removeClass("error"),c()):e("#ipnut-phoneWrap").addClass("error")}),p(),e("#changePhone").on("click",function(){g()}),e("#changePhoneBtn").on("click",function(){var t=e("#change-input-phone").val();/^1\d{10}$/.test(t)?(e("#changePhoneWrap").removeClass("error"),k.mobilephone=t,b.result.laiseeList=null,localStorage.setItem(d,JSON.stringify(b)),localStorage.setItem(f,JSON.stringify(k)),i.showTip("手机号修改成功<br />下次抢红包将会放入已修改的手机号"),e("#changePhonePage").hide(),e("#resultPage").show()):e("#changePhoneWrap").addClass("error")});var v={shareTimelineData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}},shareAppMessageData:{title:"万水千山总是情，一起臭美行不行~送你X个美发红包，一起换个新发型吧！",desc:"良辰最喜欢对那些跟我关系好的人出手了，拯救你们的发型，就用臭美App！",link:window.location.href.split("#")[0],imgUrl:"http://"+window.location.host+"/module/sf/img/share.png",type:"link",dataUrl:"",trigger:function(e){},success:function(){},cancel:function(){},fail:function(){}},initData:function(e){v.shareAppMessageData.title=v.shareTimelineData.title=e.wechatTitle,v.shareAppMessageData.link=v.shareTimelineData.link=e.h5URL,v.shareAppMessageData.imgUrl=v.shareTimelineData.imgUrl=e.imgURL,v.shareTimelineData.desc=e.wechatContent},wxCallback:function(t){wx&&(wx.config({debug:!1,appId:t.appId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){wx.checkJsApi({jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"],success:function(t){var n;"string"==typeof t?n=e.parseJSON(t):"object"==typeof t&&(n=t),n.checkResult.onMenuShareTimeline?wx.onMenuShareTimeline(v.shareTimelineData):i.alert("分享到朋友圈功能不可用！"),n.checkResult.onMenuShareAppMessage?wx.onMenuShareAppMessage(v.shareAppMessageData):i.alert("分享给朋友功能不可用！")},fail:function(){}})}),wx.error(function(e){}))}},T=function(){var e={to:"signPackage",type:"Wechat",body:{url:window.location.href.split("#")[0]}};i.ajaxRequest({data:e,successCallback:function(e){if(1==e.result){var t=e.data.main;v.wxCallback(t)}else i.alert(e.msg)},url:apiConfig.userApi})};T(),i.request({data:{orderTicketId:m},successCallback:function(t){if(0==t.code){v.initData(t.response);var n=t.response.bannerURL;n&&e("#banner").attr("src",n)}else i.showTip(t.message),23004==t.code&&(location="fail.html")},url:apiConfig.newApi+"laisee/get-laisee-info.html"})}});