define(["jquery","commonUtils","utils/module/tongdun"],function(e,i,a){var s={},t="",o=0,n="",c=0,r="",l="",d="",p=20,u=1,h=1,v=null,m=null,y=0,g=null,f=null,b=!1,k=function(e){s=JSON.parse(window.sessionStorage.getItem("user")||window.localStorage.getItem("user")),s&&(t=s.userId),r=i.getQueryString("orderSn"),n=i.getQueryString("shopcartSn"),w()},w=function(e){if(n){var a=JSON.parse(sessionStorage.getItem("bill-cart"))||{};e?i.request({data:{userId:t,shopcartSn:n,voucherId:m},url:apiConfig.newApi+"cart/place.html",successCallback:function(e){0==e.code?(l=e=e.response,x(e)):i.alert(e.message)}}):a.shopcartSn?(l=a,a.voucher&&(b=!0),x(a)):i.alert("订单无效，请重新下单")}else if(r){var a=JSON.parse(sessionStorage.getItem("bill-buynow"))||{};e?i.request({data:{userId:t,itemId:g,normsId:f,orderSn:r,voucherId:m},url:apiConfig.newApi+"order/place.html",successCallback:function(e){0==e.code?(l=e=e.response,x(e)):i.alert(e.message)}}):a.orderSn?(l=a,a.voucher&&(b=!0),x(a)):i.alert("订单无效，请重新下单")}else i.alert("参数错误，请返回重试！")},x=function(e){d=e,console.dir(e),n?S(e):r&&A(e)},I=function(){e("#vocher-choose").on("click",function(i){e("#cartOrder").hide(),e("#choose-voucher").show(),a(),v=m});var a=function(){var a={};n?a={to:"chooseVoucher",type:"Voucher",body:{userId:t,shopcartSn:n,page:u,pageSize:p}}:r&&(a={to:"chooseVoucher",type:"Voucher",body:{userId:t,orderSn:r,page:u,pageSize:p}}),i.ajaxRequest({url:apiConfig.orderApi,data:a,successCallback:function(a){var t="";if(1==a.result){if(!a.data.main)return;e.each(a.data.main,function(e,i){t+=m==i.vId?'<li data-id="'+i.vId+'" data-clicked="true" class="click"><div class="roll row"><div class="row-title normal"></div><div class="row-logo normal"></div><div class="column small-4"><span>&yen;</span><b class="money">'+i.vUseMoney+'</b></div><div class="column small-8"><div class="title">'+i.vcTitle+'</div><div class="content">'+i.limit+'</div><div class="time">'+i.vUseStart+"至"+i.vUseEnd+'</div></div><div class="line"></div><div class="clicked"><div class="clicked-bg"></div><div class="clicked-line"></div></div></div></li>':'<li data-id="'+i.vId+'" data-clicked="false" ><div class="roll row"><div class="row-title normal"></div><div class="row-logo normal"></div><div class="column small-4"><span>&yen;</span><b class="money">'+i.vUseMoney+'</b></div><div class="column small-8"><div class="title">'+i.vcTitle+'</div><div class="content">'+i.limit+'</div><div class="time">'+i.vUseStart+"至"+i.vUseEnd+'</div></div><div class="line"></div></div></li>'}),1==u?e("#choose-voucher .voucher-con ul").html(t):e("#choose-voucher .voucher-con ul").append(t),a.data.other.totalNum>=p&&1==u&&e(document).off().bind("scroll",s),u++}else i.alert(a.msg)}})},s=function(i){var s=e(document).height(),t=e(document).scrollTop(),o=e(window).height();t+o>=s&&a()};e("#choose-voucher-cancel").unbind("click").on("click",function(i){e("#cartOrder").show(),e("#choose-voucher").hide(),m=v}),e("#choose-voucher-ok").unbind("click").on("click",function(i){e("#choose-voucher li.click").length>0?(m=parseInt(e("#choose-voucher").find(".click").attr("data-id")),h=1):(m=null,h=0),w(!0),e("#choose-voucher").hide(),e("#cartOrder").show()}),e("#choose-voucher").unbind("click").on("click",".voucher-con li",{status:!0},function(i){return"false"==e(this).attr("data-clicked")?(e(".voucher-con li").attr("data-clicked","false").removeClass("click").find(".clicked").remove(),e(this).addClass("click").attr("data-clicked","true").find(".row").append('<div class="clicked"><div class="clicked-bg"></div><div class="clicked-line"></div></div>'),m=e(this).attr("data-id")):e(this).removeClass("click").attr("data-clicked","false").find(".clicked").remove(),!1})},S=function(a){var s=a.salons.length,t=0,n=[];e("#cartOrderList").html("");for(var r=0;s>r;r++){t=a.salons[r].items.length;var l=a.salons[r];n.push('<div class="order-item-box">'),n.push('<h2 class="oib-title">'+l.salonName+"</h2>");for(var d=0;t>d;d++){var p=l.items[d];if(n.push('<div class="oib-list"><div class="oib-area"><div class="clearfix"><div class="order-item-name">'+p.itemName+"</div>"),n.push('<span class="order-item-price oi-price">￥'+p.discountPrice+"</span></div>"),n.push('<div class="oip-rule"><span class="oipr-text">'+(p.normsDescription||"无规格")+"</span>"),n.push('<em class="oip-num">X'+p.quantity+"</em></div></div></div>"),n.push('<div class="cart-item-condition">'),p.buyLimits&&p.buyLimits.length>0){n.push('<ul class="clearfix">');for(var u=0,h=p.buyLimits.length;h>u;u++)n.push("<li>"+p.buyLimits[u]+"</li>");n.push("</ul>")}var v=p.useLimit;v&&n.push('<p class="cart-item-tips">'+v+"</p>"),n.push("</div>")}n.push('<div class="order-sum"><span>共<em>'+l.totalQuantity+"</em>个项目</span>"),n.push('<span>小计：<em class="oi-price">￥'+l.totalAmount+"</em></span></div></div>")}b?(a.voucher?(m=a.voucher.vId,e(".vocher-pay-content").html('<div class="vocher-top"><span>现金券:</span><span class="vocher-title vocher-choose-click">'+a.voucher.name+'<span style="display: inline-block; background:url(../../images/user/next_pressed@2x.png) no-repeat left top;width: 20px; height: 15px;-webkit-background-size: contain;background-size: contain;vertical-align: middle;margin-left: 8px;  position: relative;top: -1px;"></span></span></div><div class="vocher-bottom"><span class="vocher-list-type">项目: <span class="vocher-list-title">'+a.voucher.appliedItemName+'</span></span><span class="vocher-list-con">立减 <div id="vocher-pay-num"> ￥'+a.voucher.usableAmount+"</div></span></div>")):e(".vocher-pay-content").html("<div><span>现金券:</span><b style='font-weight: normal;float: right'>选择现金券 <span style='display: inline-block; background:url(../../images/user/next_pressed@2x.png) no-repeat left top;width: 20px; height: 15px;-webkit-background-size: contain;background-size: contain;vertical-align: middle;margin-left: 8px;  position: relative;top: -1px;'></span></b></div>"),I()):e(".vocher-pay-content").html("<span>现金券:</span><b style='font-weight: normal;float: right'>无可用现金券</b>"),e(n.join("")).appendTo(e("#cartOrderList")),e("#needPay").text("￥"+a.payableAmount),e("#remainPayAmount").text("￥"+a.thirdpayAmount),e("#choumeiBalance").html("￥"+a.userBalance),y=a.userBalance,a.thirdpayAmount>0?(i.isOpenInWechat()?(e("#otherPay .pay-item:eq(0)").hide(),o=2):(e("#otherPay .pay-item:eq(1)").hide(),o=1),e("#otherPayWay").show(),e("#otherPay").show(),C()):(e("#otherPayWay").hide(),e("#otherPay").hide(),o=0),c=a.thirdpayAmount,P()},A=function(a){var s=[],t="";if(f=a.normsId,r=a.orderSn,g=a.itemId,e("#cartOrderList").html(""),s.push('<div class="order-item-box">'),s.push('<h2 class="oib-title">'+a.salonName+"</h2>"),s.push('<div class="oib-list"><div class="oib-area"><div class="clearfix"><div class="order-item-name">'+a.itemName+"</div>"),s.push('<span class="order-item-price oi-price">￥'+a.totalAmount+"</span></div>"),t=a.normsDescription||"无规格",s.push('<div class="oip-rule"><span class="oipr-text">'+t+"</span>"),s.push('<em class="oip-num">X'+a.quantity+"</em></div></div></div>"),s.push('<div class="cart-item-condition">'),a.buyLimits&&a.buyLimits.length>0){s.push('<ul class="clearfix">');for(var n=0,l=a.buyLimits.length;l>n;n++)s.push("<li>"+a.buyLimits[n]+"</li>");s.push("</ul>")}var d=a.useLimit;d&&s.push('<p class="cart-item-tips">'+d+"</p>"),s.push("</div>"),s.push('<div class="order-sum"><span>共<em>'+a.quantity+"</em>个项目</span>"),s.push('<span>小计：<em class="oi-price">￥'+a.totalAmount+"</em></span></div></div>"),e(s.join("")).appendTo(e("#cartOrderList")),e("#needPay").text("￥"+a.payableAmount),e("#remainPayAmount").text("￥"+a.thirdpayAmount),e("#choumeiBalance").html("￥"+a.userBalance),y=a.balance,a.thirdpayAmount>0?(i.isOpenInWechat()?(e("#otherPay .pay-item:eq(0)").hide(),o=2):(e("#otherPay .pay-item:eq(1)").hide(),o=1),e("#otherPayWay").show(),e("#otherPay").show(),C()):(e("#otherPayWay").hide(),e("#otherPay").hide(),o=0),c=a.thirdpayAmount,P(),b?(a.voucher?(m=a.voucher.vId,e(".vocher-pay-content").html('<div class="vocher-top"><span>现金券:</span><span class="vocher-title vocher-choose-click">'+a.voucher.name+'<span style="display: inline-block; background:url(../../images/user/next_pressed@2x.png) no-repeat left top;width: 20px; height: 15px;-webkit-background-size: contain;background-size: contain;vertical-align: middle;margin-left: 8px;  position: relative;top: -1px;"></span></span></div><div class="vocher-bottom"><span class="vocher-list-type">项目: <span class="vocher-list-title">'+a.itemName+'</span></span><span class="vocher-list-con">立减 <div id="vocher-pay-num"> ￥'+a.voucher.usableAmount+"</div></span></div>")):e(".vocher-pay-content").html("<div><span>现金券:</span><b style='font-weight: normal;color:#aaa;float: right'>选择现金券 <span style='display: inline-block; background:url(../../images/user/next_pressed@2x.png) no-repeat left top;width: 20px; height: 15px;-webkit-background-size: contain;background-size: contain;vertical-align: middle;margin-left: 8px;  position: relative;top: -1px;'></span></b></div>"),I()):e(".vocher-pay-content").html("<span>现金券:</span><b style='font-weight: normal;float: right'>无可用现金券</b>")},C=function(){e("#otherPay > div").on("click",function(){o=e(this).attr("payWay"),e("#otherPay > div div.selectBtn").removeClass("select-btn"),e("#otherPay > div div.selectBtn").addClass("unselect-btn"),e(this).find("div.selectBtn").removeClass("unselect-btn"),e(this).find("div.selectBtn").addClass("select-btn")})},P=function(){o>0?e("#header").text("选择支付方式"):e("#header").text("余额支付"),e("#submitPayBtn").off().one("click",function(){var e=[];y>0&&e.push(4),1==o?e.push(2):2==o?e.push(1):3==o&&e.push(3),e=e.join(),n?tongdun({url:"trade/shopcart/pay.html",data:{shopcartSN:n,payType:e}}):tongdun({url:"trade/shopcart/pay.html",data:{orderSN:r,payType:e}}),o>0?1==o?O():2==o?N():3==o&&L():q()})},q=function(){var e={};n?e={to:"moneyPay",type:"Shopcart",body:{userId:t,shopcartsn:n,vId:m}}:r&&(e={to:"confirmPay",type:"Order",body:{userId:t,orderSn:r,vId:m}}),i.ajaxRequest({data:e,successCallback:function(e){e.result?n?window.location="paySuccess.html?shopcartSn="+n:r&&(window.location="paySuccess.html?orderSn="+r):(i.showTip(e.msg),console.log("余额支付失败！"+e.msg))},url:apiConfig.orderApi})},L=function(){i.request({url:apiConfig.newApi+"payeco/placeh5.html",data:{shopcartsn:n,ordersn:r,amount:c,userId:t},successCallback:function(e){0==e.code?location=e.response.payUrl:i.alert(e.message)}})},N=function(){var a={shopcartsn:n,ordersn:r,amount:c,userId:t},s=window.navigator.userAgent,o="bundle=FQA5WK2BN43YRM8Z&version=5.3&device-type=WECHAT&device-dpi="+window.screen.width+"x"+window.screen.height+"&device-model=&device-network=&device-uuid="+i.randomString()+"&device-cpu=&device-os="+s+"&timestamp="+(new Date).getTime()+"&sequence="+i.requestTime+i.requestCount++ +"&access-token="+i.cache.accessToken+"&request="+JSON.stringify(a);o+="&sign="+e.md5(o),o=o.replace(/device-os=([^&]*)(&|$)/,"device-os="+encodeURIComponent(s)+"&"),location=apiConfig.newApi+"wechat/placeh5.html?"+o},O=function(){i.request({url:apiConfig.newApi+"alipay/placeh5.html",data:{shopcartsn:n,ordersn:r,amount:c,userId:t},successCallback:function(a){if(console.dir(a),0==a.code){var s=document.createElement("form"),t=[];s.action="https://mapi.alipay.com/gateway.do?_input_charset=utf8",s.setAttribute("id","alipayForm"),s.className="hide",e.each(a.response.wapPay,function(e,i){t.push('<input value ="'+i+'" name="'+e+'">')}),s.innerHTML=t.join(""),document.body.appendChild(s),s.submit()}else i.alert(a.message)}})};return{init:k}});