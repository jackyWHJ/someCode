define(["jquery","commonUtils","libs/plugins/swiper/swiper.min","jquery.lazyLoad"],function(t,i,a){var s={salonId:i.getQueryString("salonId"),itemId:i.getQueryString("itemId"),stylistId:i.getQueryString("stylistId"),type:i.getQueryString("type"),satisfyType:i.getQueryString("satisfyType")||0,loadTag:{end:!1},flag:"true",init:function(){s.action.init(),s.view.clickElem()},data:{cache:{},rangeKey:Math.random(),listData:{pageNum:0,pageSize:10,data:null,load:function(a){var e=apiConfig.newApi,n={satisfyType:s.satisfyType,contentNotBlank:s.flag,pageNum:++this.pageNum};s.salonId?(n.salonId=s.salonId,e+="comment/salon.html",t("#satisfyLabel").text("满意度：")):s.itemId?(n.itemId=s.itemId,e+="comment/item.html",t("#satisfyLabel").text("满意度：")):s.stylistId&&(n.stylistId=s.stylistId,e+="comment/stylist.html",t("#satisfyLabel").text("好评度：")),i.request({data:n,url:e,successCallback:function(t){0==t.code?(s.data.listData.data=t.response,a(),s.view.init(),s.data.listData.data.stats.commentNum<n.pageSize&&(s.loadTag.end=!1)):i.showTip(t.message)}})}}},view:{init:function(){this.initSortList(),this.swiper.init()},clickElem:function(){t("#vc-sortList").on("click","li",function(){t(this).addClass("active").siblings().removeClass("active"),s.satisfyType=t("#vc-sortList li").index(t(this)),t("#noCommentTips").hide(),t("#commentList").show(),s.action.loadList(!0)}),t("#sbCheck").on("click",function(){var i=t(this).attr("contentNotBlank");"true"==i?(t(this).find("i").addClass("sbci-unselected"),s.flag="false",t(this).attr("contentNotBlank","false")):(t(this).find("i").removeClass("sbci-unselected"),s.flag="true",t(this).attr("contentNotBlank","true")),s.action.loadList(!0)})},initSortList:function(){t("#vc-sortList").find("li").eq(s.satisfyType).addClass("active").siblings().removeClass("active");var i=s.data.listData.data.stats,a=i.commentNum,e=i.verySatisfiedNum,n=i.satisfiedNum,l=i.unsatisfiedNum,c=i.satisfaction;t("#satisfy-all").text(a),t("#satisfy-very").text(e),t("#satisfy-ok").text(n),t("#satisfy-bad").text(l),t("#satisfactionDegree").text(c),(3==s.satisfyType&&0==l||2==s.satisfyType&&0==n||1==s.satisfyType&&0==e)&&(t("#noCommentTips").show().find("p").text("暂无此类评价"),t("#commentList").hide())},grader:{getGrade:function(t){return 5>t?["h",t+1]:10>t?["d",t%5+1]:["c",t%5+1]},getGradeStr:function(t){for(var t=this.getGrade(Number(t)),i=[],a=t[0],s=t[1];s>0;s--)i.push("<i class='grade "+a+"'></i>");return i.join("")}},updateList:function(i){var a=s.data.listData.data.data,e=[],n=t("#commentList");t.each(a,function(i,a){e.push('<div class="vc-cl-commentItem">'),e.push('<div class="vc-cl-content"><div class="vc-cl-head">'),a.avatar=a.avatar?a.avatar:"../../images/default_img.png",e.push('<img src="'+a.avatar+'" alt="个人头像" class="vc-cl-headImg"/>'),e.push('<span class="csi">'+a.satisfyType+'</span><span class="vc-cl-tel">'+a.phone+"</span></div>"),e.push('<div class="vc-cl-comment"><p class="vc-cl-commentDesc">'+a.content+"</p>");var n=a.images;if(n){var l=s.data.rangeKey++;e.push('<ul class="vc-cl-imgList" datakey ="'+l+'">');var c=[];t.each(n,function(t,i){e.push('<li><img src="../../images/default_img.png"  class="vc-cl-img lazy" data-original="'+i.thumb.url+'"/></li>'),c.push(i.image.url)}),s.data.cache[l]=c,e.push("</ul>")}e.push("</div>"),e.push('<p class="vc-cl-time">'+a.createTime+"</p>"),a.reply&&e.push('<p class="vc-cl-reply">'+a.reply+"</p>"),e.push("</div></div>")}),i&&(0==a.length?(t("#noCommentTips").show().find("p").text("暂无有内容的评价"),t("#commentList").hide()):(n.empty(),t("#noCommentTips").hide(),t("#commentList").show())),n.append(e.join("")),t("img.lazy").removeClass("lazy").lazyload({effect:"fadeIn"}),t(".vc-cl-imgList li").each(function(){var i=t(this);i.height(i.width())}),1==s.data.listData.pageNum},swiper:{init:function(){t("#commentList").on("click",".vc-cl-imgList li",function(){var i=[],e=t("#swiper-containerWrap"),n=s.data.cache[t(this).parent().attr("dataKey")],l=t(this).index();console.dir(n),i.push('<div class="swiper-container full" id="swiper-container"><div class="swiper-wrapper" id="fullSwiper">'),t.each(n,function(t,a){i.push('<div class="swiper-slide"><img  src="../../images/default_salon.png" onerror="this.src=\'../../images/default_img.png\'" data-src="'),i.push(a),i.push('" index = "'+t),i.push('" class="swiper-lazy" /></div>')}),i.push('</div><div class="swiper-pagination"></div></div>'),e.html(i.join("")),e.show(),new a("#swiper-container",{autoplay:!1,pagination:".swiper-pagination",paginationClickable:!0,preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,initialSlide:l}),e.on("click",function(){e.hide()})})}}},action:{init:function(){this.initList()},initList:function(){function i(){var a=t(document),e=t(window).height();a.scrollTop()+e>=a.height()&&s.action.loadList(!1),1==s.loadTag.end&&a.off("scroll",i)}t(document).on("scroll",i),this.loadList(!0)},loadList:function(t){t&&(s.data.listData.pageNum=0),s.data.listData.load(function(){s.view.updateList(t)})}}};return{init:s.init}});