define(["jquery","commonUtils","jquery.lazyLoad","swiper"],function(a,i,t,s){var n={init:function(){this.loadTag={end:!1,firstTime:!0},this.view.resetImgH(),this.action.salonListInit(),i.goTop(),i.addBack()},loadTag:{end:!1,firstTime:!0},data:{type:1,keyword:"",listData:{page:0,pageSize:20,load:function(a){var t={district:e.data.circle[0]||0,zone:e.data.circle[1]||0,"long":l.addr.addrLong,lati:l.addr.addrLati},s=apiConfig.newApi;1==n.data.type?s+="salon/praise.html":2==n.data.type?(s+="salon/nearby.html",t.keyword="",t.pageNum=++this.page,t.pageSize=this.pageSize):3==n.data.type&&(s+="salon/star.html",t.pageNum=++this.page,t.pageSize=this.pageSize),i.request({data:t,successCallback:a,url:s}),console.log(t)}}},view:{resetImgH:function(){function i(){var i=a(window).width()*n;i>280?i=280:"",a("#imgHResetStyle").remove(),a("<style id='imgHResetStyle'> .sl-imgWrap{height:"+i+"px } </style>").appendTo(a("head"))}var t=690,s=280,n=.9/(t/s);i(),a(window).on("resize",i)},updateSalonList:function(i){if(console.log(i),0==i.code){var t=i.response,s=t.salons;if(0==s.length)return n.loadTag.end=!0,n.loadTag.firstTime&&(a("#noResearchResult").show(),a("#salonList").hide()),-1;n.loadTag.firstTime=!1;var e=[];a.each(s,function(a,i){var t="<li salonId="+i.salonId+'><div class="sl-imgWrap"><img  class="sl-img lazy" src="../../images/default_salon.png" data-original="'+i.img+'" alt="臭美店铺" /></div><div class="sl-desc"><div class="clearfix"><h1 class="sl-name text-overflow">'+i.name+'</h1><span class="si-star"><span class="sl-xing"></span><span class="sl-stars">'+i.stars+'</span></span><span class="sl-d-info"><span class="sl-addr">'+i.areaName+'</span><span class="sl-distance">'+i.dist+'</span></span></div><ul class="sl-info"><li class="comment"><span class="tip">评价数&nbsp;&nbsp;</span><span class="num">'+i.commentNum+'</span></li><li class="satisfyNum"><span class="tip">满意数&nbsp;&nbsp;</span><span class="num">'+i.satisfy+'</span></li><li class="csi"><span class="tip">满意度&nbsp;&nbsp;</span><span class="num">'+i.satisfaction+"</span></li></ul></div></li>";e.push(t)}),a("#salonList").append(e.join("")),a("img.lazy").removeClass("lazy").lazyload({effect:"fadeIn"})}}},action:{salonListInit:function(){function i(){if(1!=a("#salonList:hidden").length){var t=a(document),s=a(window).height();t.scrollTop()+s>=t.height()&&n.data.type&&n.action.loadList(),1==n.loadTag.end&&t.off("scroll",i)}}n.data.type&&a(document).on("scroll",i);var t=a("#salonList");t.on("click","li",function(){location="salonIndex.html?salonId="+a(this).attr("salonId")}),t.empty(),this.loadList()},loadList:function(i){i&&(a("#salonList").empty().show(),a("#noResearchResult").hide(),n.loadTag={end:!1,firstTime:!0},n.data.listData.page=0),n.data.listData.load(n.view.updateSalonList)}}},e={init:function(){this.initSalonType(),n.init(),e.data.loadCircleList(e.circle.init)},data:{circle:[],circleList:null,keyword:window.sessionStorage.getItem("keywords"),loadCircleList:function(a){var t={type:0};i.request({url:apiConfig.newApi+"location/allArea.html",data:t,successCallback:function(i){e.data.circleList=i.response,a(i)}})}},initSalonType:function(){a("#sl-h-tab li").on("click",function(){a(this).addClass("active").siblings().removeClass("active"),n.data.type=a(this).index()+1,n.action.loadList(!0)});var t=i.getQueryString("salonType");t&&(n.data.type=t,a("#sl-h-tab li").eq(t-1).addClass("active").siblings().removeClass("active"))},circle:{init:function(){function i(i){var t=[];a.each(d,function(n,e){if(i==e.tId||i==e.tName){a.each(e.areaInfo,function(a,i){t.push('<li zone="'+i.areaId+'">'+i.areaName+"</li>")}),o.html(t.join(""));var d=o.find("li[zone="+c[1]+"]");return d.length>0?d.addClass("active"):o.find("li:first").addClass("active"),r=[e.tId],l=e.tName,s.find("li[district="+e.tId+"]").addClass("active").siblings().removeClass("active"),!1}})}var t=a("#circle"),s=t.find(".district"),l="",o=t.find(".zone"),d=null,c=[],r=[],p=[];d=e.data.circleList,a("#sl-h-pos").on("click",function(){var i=a(this);i.toggleClass("active"),t.toggle(),s.find("li[district="+c[0]+"]").click()}),a.each(d,function(a,i){p.push('<li district="'+i.tId+'">'+i.tName+"</li>")}),s.html(p.join("")),s.on("click","li",function(){i(a(this).attr("district"))}),o.on("click","li",function(){var i=a(this);c=[r[0],i.attr("zone")],e.data.circle=c,i.addClass("active").siblings().removeClass("active"),n.action.loadList(!0),a("#sl-h-posText").text(l),a("#sl-h-pos").click()}),i(0),n.action.loadList(!0)}}},l={addr:{addrLati:window.localStorage.getItem("addrLati")||geoLoc.addrLati,addrLong:window.localStorage.getItem("addrLong")||geoLoc.addrLong},addrCom:null,init:function(){this.setPosition()},setPosition:function(){window.navigator.geolocation?(i.showLoading(),window.navigator.geolocation.getCurrentPosition(function(a){var t=a.coords.longitude,s=a.coords.latitude,n=new BMap.Point(t,s);BMap.Convertor.translate(n,0,function(a){window.localStorage.setItem("addrLong",a.lng),window.localStorage.setItem("addrLati",a.lat),l.addr.addrLong=a.lng,l.addr.addrLati=a.lat;var t=new BMap.Geocoder;t.getLocation(a,function(a){l.addrCom=a.addressComponents,e.init()}),i.hideLoading()})},function(a){i.alert("我们为您准备了更好的推荐服务，请允许微信访问地理位置信息\n您可以在“设置”中允许微信访问位置信息。"),e.init()},{enableHighAccuracy:!0,timeout:7e3})):i.alert("浏览器不支持html5来获取地理位置信息")}},o=function(){l.init()};return{init:o}});