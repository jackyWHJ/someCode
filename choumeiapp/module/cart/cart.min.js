define(["jquery","commonUtils","utils/module/tongdun"],function(t,e,a){var s="",o={},n={},i="",l=function(){o=JSON.parse(window.sessionStorage.getItem("user")||window.localStorage.getItem("user")),o&&(s=o.userId),s?(c(),t("#loginOrShop").hide()):(t("#cartContent,#cartFooter").hide(),t("#noItemContent").show(),t("#loginOrShop").text("去登录").on("click",function(){window.sessionStorage.setItem("location",window.location),window.location="../user/userLogin.html"}))},c=function(){var a={userId:s},o=function(){t("#cartContent,#cartFooter").hide(),t("#noItemContent").show()};e.request({data:a,successCallback:function(t){0==t.code?(t=t.response,console.dir(t),t.salons.length>0?r(t.salons):o()):(e.showTip(t.message),o())},url:apiConfig.newApi+"cart/list.html"})},r=function(e){if(e){for(var a=[],s=e,o=[],i=0;i<e.length;i++){o=s[i].items;var l=o.length;a.push('<div class="shop-item-div" id="salon'+s[i].salonId+'"><div class="shop-item-p"><div id="salonSelector'+s[i].salonId+'" class="salonSelector select-icon" flag="off" salonId="'+s[i].salonId+'"></div>'),a.push('<div class="shop-name text-overflow">'+s[i].salonName+"</div></div>");for(var c=0;l>c;c++){if(n[o[c].cartItemId]=o[c].discountPrice,a.push('<div class="shop-item-p cart-item-info" deleteStatus="hidden" id="item'+o[c].cartItemId+'"><div class="itemSelector select-icon" flag="off" cartItemId="'+o[c].cartItemId+'" itemId="'+o[c].itemId+'" salonId="'+s[i].salonId+'"></div>'),a.push('<div class="item-content"><div><div class="item-name text-overflow">'+o[c].itemName+"</div>"),a.push('<span class="price-span">￥'+o[c].discountPrice+"</span></div>"),a.push('<div class="rule-content">'+(o[c].normsDescription?o[c].normsDescription:"规格：不限；")+"</div>"),a.push('<div class="number-input"><span class="cart-sprite-img sub-btn" cartItemId="'+o[c].cartItemId+'" itemId="'+o[c].itemId+'" salonId="'+s[i].salonId+'"></span><span class="number-label" id="itemLabel'+o[c].cartItemId+'">'+o[c].quantity+'</span><span class="cart-sprite-img add-btn" cartItemId="'+o[c].cartItemId+'" itemId="'+o[c].itemId+'" salonId="'+s[i].salonId+'"></span></div></div>'),a.push('<a href="javascript:void(0)" cartItemId="'+o[c].cartItemId+'" class="sip-delete"></a></div>'),o[c].buyLimits&&o[c].buyLimits.length>0){var r=o[c].buyLimits.length;a.push('<div class="cart-item-condition"><ul class="clearfix" style="border-top: 0;margin-left:15px">');for(var m=0;r>m;m++)a.push("<li>"+o[c].buyLimits[m]+"</li>");a.push("</ul></div>")}o[c].useLimit&&a.push('<p class="cart-item-tips">'+o[c].useLimit+"</p>")}a.push('<div class="shop-total"><div class="item-count">共<span id="numSpan'+s[i].salonId+'">'+s[i].totalQuantity+'</span>个项目</div><div class="money-total">小计：<span id="priceSpan'+s[i].salonId+'" class="price-span">￥'+s[i].totalAmount+"</span></div></div></div>")}t("#cartContent").html(a.join("")),d(),u()}},d=function(){t(".salonSelector").on("click",function(e){e.stopPropagation(),"on"==t(this).attr("flag")?(t(this).attr("flag","off").removeClass("selected-icon"),I(t(this).attr("salonId"),"off")):(t(this).attr("flag","on").addClass("selected-icon"),I(t(this).attr("salonId"),"on")),g()&&t("#allSelector").attr("flag","on").addClass("selected-icon"),v()}),t(".itemSelector").on("click",function(e){e.stopPropagation(),"on"==t(this).attr("flag")?t(this).attr("flag","off").removeClass("selected-icon"):t(this).attr("flag","on").addClass("selected-icon"),b(t(this).attr("salonId"))?t("#salonSelector"+t(this).attr("salonId")).attr("flag","on").addClass("selected-icon"):t("#salonSelector"+t(this).attr("salonId")).attr("flag","off").removeClass("selected-icon"),v()}),t(".sub-btn").on("click",function(e){e.stopPropagation();var a=t(this).attr("salonId"),s=t(this).attr("itemId"),o=t(this).attr("cartItemId"),n=Number(t("#itemLabel"+o).text());n--,n>0&&(p(a,s,o,n,2),m(o,-1))}),t(".add-btn").on("click",function(e){e.stopPropagation();var a=t(this).attr("salonId"),s=t(this).attr("itemId"),o=t(this).attr("cartItemId"),n=Number(t("#itemLabel"+o).text());n++,11>n&&(p(a,s,o,n,1),m(o,1))}),t("#allSelector").on("click",function(){"on"==t(this).attr("flag")?(t(this).attr("flag","off").removeClass("selected-icon"),t(".salonSelector").attr("flag","off").removeClass("selected-icon"),t(".itemSelector").attr("flag","off").removeClass("selected-icon")):(t(this).attr("flag","on").addClass("selected-icon"),t(".salonSelector").attr("flag","on").addClass("selected-icon"),t(".itemSelector").attr("flag","on").addClass("selected-icon")),v()}),t("#submitCartBtn").on("click",function(){return S()?void f():void e.showTip("请至少选择一个项目！")})},u=function(){t("#editBtn").on("click",function(){t("#editBtn,#submitDiv").hide(),t("#completeBtn,#deleteDiv").show()}),t("#completeBtn").on("click",function(){t("#completeBtn,#deleteDiv").hide(),t("#editBtn,#submitDiv").show()}),t("#deleteBtn").on("click",function(){return S()?void e.confirm("确定要删除这个项目吗?",function(e){e?h():(t("#completeBtn,#deleteDiv").hide(),t("#editBtn,#submitDiv").show(),t(".select-icon").attr("flag","off").removeClass("selected-icon"))}):void e.showTip("请至少选择一个项目！")})},m=function(t,a){var o={userId:s,cartItemId:t,quantity:a};e.request({data:o,successCallback:function(t){0!=t.code&&e.alert(t.message)},url:apiConfig.newApi+"cart/plus.html",showLoading:!1})},f=function(){var t={userId:s,cartItemIds:i};tongdun({url:"order/shopcart/submit.html",data:{cartItemIds:i}}),e.request({data:t,successCallback:function(t){0==t.code?(sessionStorage.setItem("bill-cart",JSON.stringify(t.response)),window.location="cartOrder.html?shopcartsn="+t.response.shopcartSn):e.showTip(t.message)},url:apiConfig.newApi+"cart/place.html"})},p=function(e,a,s,o,i){var l=t("#priceSpan"+e).text();l=l.substr(1,l.length-1),t("#itemLabel"+s).text(o),1==i?(t("#numSpan"+e).text(Number(t("#numSpan"+e).text())+1),t("#priceSpan"+e).text("￥"+(Number(l)+Number(n[s])))):(t("#numSpan"+e).text(Number(t("#numSpan"+e).text())-1),t("#priceSpan"+e).text("￥"+(Number(l)-Number(n[s])))),v()},h=function(){var t={userId:s,cartItemIds:i};e.request({data:t,successCallback:function(t){0==t.code?window.location.reload():e.showTip(t.message)},url:apiConfig.newApi+"cart/delete.html"})},I=function(e,a){t(".itemSelector").each(function(){t(this).attr("salonId")==e&&("on"==a?t(this).attr("flag",a).addClass("selected-icon"):t(this).attr("flag",a).removeClass("selected-icon"))})},v=function(){i=[];var e=0,a="",s="",o=1,l="on";t(".itemSelector").each(function(){var c=t(this);"on"==c.attr("flag")?(a=c.attr("salonId"),s=c.attr("itemId"),i.push(c.attr("cartItemId")),o=t("#itemLabel"+c.attr("cartItemId")).text(),e+=Number(o)*n[c.attr("cartItemId")]):l="off"}),t("#totalMoney").text("￥"+e),"off"==l?t("#allSelector").attr("flag","off").removeClass("selected-icon"):t("#allSelector").attr("flag","on").addClass("selected-icon")},g=function(){var e=!0;return t(".salonSelector").each(function(){return"off"==t(this).attr("flag")?e=!1:void 0}),e},b=function(e){var a=!0;return t(".itemSelector").each(function(){return"off"==t(this).attr("flag")&&t(this).attr("salonId")==e?a=!1:void 0}),a},S=function(){var e=!1;return t(".itemSelector").each(function(){return"on"==t(this).attr("flag")?e=!0:void 0}),e};return{init:l}});