define(["jquery","commonUtils"],function(e,t){var a,i,s,n=e("#datePage"),o=e(".gender"),l=e("#referrerPage"),d=e("#recommendedCodeWrap"),c=t.getQueryString("itemId"),r=function(){t.checkLogin()&&(u(),t.addBack("#appointPage .header"),t.addMenu("#appointPage .header"),e("#datePage .header .back,#referrerPage .header .back").on("click",function(){e(this).closest(".slide-page").removeClass("slideInRight").addClass("slideOutRight")}))},u=function(){t.request({url:apiConfig.newApi+"booking/items.html",successCallback:p})},p=function(i){if(0!=i.code)return void t.alert(i.message);i=i.response,a=i.beautyId;var s=[],n=e("#itemListContainer");e.each(i.groups,function(t,a){s.push('<div class="appoint-itemListWrap" groupType = '+a.groupType+' ><div class="title"><h3>'+a.groupName+"</h3>"),s.push('<h4>韩国国家美容联合会XXXXXXXXX介绍</h4></div><ul class="appoint-itemList">'),e.each(a.items,function(e,t){s.push("<li itemId = "+t.itemId+" class="+(c==t.itemId?"selected":"")+'><span class="itemName">'+t.itemName+'</span><i class="selectIco"></i></li>')}),s.push("</ul></div>")}),n.html(s.join("")),n.find(".appoint-itemList").on("click","li",function(){e(this).toggleClass("selected")}),"N"==i.recommendEnable?d.hide():d.show(),m()};e("#selectTime").on("click",function(){n.show(),n.addClass("slideInRight").removeClass("slideOutRight")});var m=function(){t.request({data:{beautyId:a},url:apiConfig.newApi+"booking/calendar.html",successCallback:h})},h=function(a){if(0!=a.code)return void t.alert(a.message);a=a.response;var i=[],s=e("#calendar");e.each(a,function(e,t){i.push('<span class="dateWrap '+("Y"==t.isFull?"full":"")+'" date='+t.bookingDate+'><div class="content"><span class="day">'),i.push(t.bookingWeek+'</span><span class="date">'+t.displayDate+"</span></div></span>")}),s.html(i.join("")),s.on("click",".dateWrap",function(){var t=e(this),a=e("#appoint-date"),i=t.find(".day").text(),o=(t.find(".date").text(),t.attr("date"));t.hasClass("full")||(a.text(o+"("+i+")").attr("date",o),t.toggleClass("selected").siblings("").removeClass("selected"),0!=s.find(".selected").length&&n.removeClass("slideInRight").addClass("slideOutRight"))})};return o.on("click",function(){o.removeClass("selected"),e(this).addClass("selected")}),d.on("click",function(){l.addClass("slideInRight").removeClass("slideOutRight").show()}),e("#validateCode").on("click",function(){var a="SLN";s=e("#inputCode").val(),s.match(/^1\d{10}$/)?a="PRS":"",t.request({data:{recommendedCode:s,type:a},url:apiConfig.newApi+"recommended-code/submit.html",successCallback:function(a){0!=a.code?t.alert(a.message):(i=s,e("#recommendedCode").text(i),l.removeClass("slideInRight").addClass("slideOutRight"))}})}),e("#submitAppoint").on("click",function(){var a=[],s=e("#itemListContainer").find(".selected");if(e.each(s,function(t,i){a.push(e(this).attr("itemId"))}),0==a.length)return void t.alert("未选择项目");var n=e("#appoint-date").attr("date");if(!n)return void t.alert("未选择日期");var o=e("#bookerName").val();return o?t.strlen(o)>10?void t.alert("用户名过长，长度要控制在10个字符以内"):void t.request({data:{itemIds:a,bookingDate:n,bookerName:o,recommendedCode:i,bookerSex:e(".gender.selected").hasClass("female")?"F":"M",bookerPhone:""},url:apiConfig.newApi+"booking/place.html",successCallback:function(e){0!=e.code?t.alert(e.message):(sessionStorage.setItem("appoint-bill",JSON.stringify(e)),location="appoint-pay.html")}}):void t.alert("未填写姓名")}),{init:r}});